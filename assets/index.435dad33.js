import{n as C}from"./side-effect-manager.es.c07e661e.js";import{e as W}from"./ensure-attributes.2c659353.js";import{L as T}from"./logger.82a2fe3a.js";import"./randomColor.7bbb2fda.js";import"./index.88f12c1b.js";import"./modulepreload-polyfill.c7c6310f.js";const j=`.netless-app-embedded-page{width:100%;height:100%;position:relative}.netless-app-embedded-page iframe{width:100%;height:100%;border:none;display:block}.netless-app-embedded-page-wb-view{width:100%;height:100%;position:absolute;top:0;left:0;overflow:hidden}
`;function l(a){return typeof a=="object"&&a!==null}const V={kind:"EmbeddedPage",config:{enableShadowDOM:!1},setup(a){const h=a.getAppOptions()||{},{displayer:i,room:o,box:E}=a,w=h.debug,S="state",d=W(a,{src:"https://example.org",store:{[S]:{}},page:""}),p=new C,m=new T("EmbeddedPage",w),b=e=>{try{return l(e)?JSON.parse(JSON.stringify(e)):e}catch(t){throw m.error("Cannot parse to JSON object",e),t}},g=document.createElement("div");g.dataset.appKind="EmbeddedPage",g.classList.add("netless-app-embedded-page");const u=document.createElement("iframe");g.appendChild(u),E.mountStyles(j),E.mountContent(g);const M=e=>e.map(({memberId:t,payload:s})=>({sessionUID:t,uid:(s==null?void 0:s.uid)||"",userPayload:b(s)})),v=(e,t)=>{let s=null;const r=a.mobxUtils.reaction(e,()=>{s&&(s(),s=null);const n=e();l(n)&&(s=()=>a.objectUtils.unlistenUpdated(n,t),a.objectUtils.listenUpdated(n,t))},{fireImmediately:!0});return()=>{s==null||s(),r()}},c=h.postMessage||(e=>{var t;m.log("Message to SDK",e),(t=u.contentWindow)==null||t.postMessage(e,"*")}),I=h.addMessageListener||((e,t)=>{const s=({data:r,source:n})=>{n!==u.contentWindow||!l(r)||!r.NEAType||(m.log("Message from SDK",r),e(r))};return window.addEventListener("message",s,t),()=>{window.removeEventListener("message",s,t)}});let y;const A=e=>{y&&l(e)&&y.moveCamera({centerX:e.x,centerY:e.y})},N=e=>{l(e)&&Object.keys(e).forEach(t=>{if(t!==S){const s=e[t];a.updateAttributes(["store",t],s)}})},P=e=>{if(l(e)&&e.storeId&&l(e.state)){const{storeId:t,state:s}=e;if(!a.isWritable){m.error(`Cannot setState on store ${t} without writable access`,s);return}Object.keys(s).forEach(r=>{a.updateAttributes(["store",t,r],s[r])})}};p.add(()=>{const e=new C,t=r=>{e.add(()=>v(()=>d.store[r],n=>{c({NEAType:"StateChanged",payload:{storeId:r,actions:b(n)}})}),r)};Object.keys(d.store).forEach(t);const s=v(()=>d.store,r=>{c({NEAType:"StoreChanged",payload:b(r)}),d.store&&r.forEach(({key:n,kind:U})=>{switch(U){case 2:{e.flush(n);break}default:{t(n);break}}})});return()=>{e.flushAll(),s()}}),p.add(()=>{const e=t=>{t!=null&&t.roomMembers&&c({NEAType:"RoomMembersChanged",payload:M(t.roomMembers)})};return i.callbacks.on("onRoomStateChanged",e),()=>i.callbacks.off("onRoomStateChanged",e)});const k=e=>{y||(y=a.createWhiteBoardView());const t=a.getInitScenePath();if(typeof e=="string"&&a.isWritable&&t&&o){const s=[t,e].join("/");o.scenePathType(s)==="none"&&o.putScenes(t,[{name:e}]),a.setScenePath(s),a.updateAttributes(["page"],e)}};p.add(()=>{const e=(t,s)=>{c({NEAType:"PageChanged",payload:{oldValue:s,newValue:t}})};return a.mobxUtils.reaction(()=>d.page,e)}),p.add(()=>{const e=()=>{const t=a.isWritable;c({NEAType:"WritableChanged",payload:t}),m.log(`WritableChange changed to ${t}`)};return a.emitter.on("writableChange",e),()=>a.emitter.off("writableChange",e)});const f=`channel-${a.appId}`,L=e=>{a.isWritable&&o&&o.dispatchMagixEvent(f,e)};p.add(()=>{const e=t=>{t.event===f&&t.authorId!==i.observerId&&c({NEAType:"ReceiveMagixMessage",payload:t.payload})};return i.addMagixEventListener(f,e),()=>i.removeMagixEventListener(f,e)});const O=()=>{var s;const e=i.observerId,t=(s=i.state.roomMembers.find(r=>r.memberId===e))==null?void 0:s.payload;c({NEAType:"Init",payload:{appId:a.appId,page:d.page,writable:a.isWritable,roomMembers:M(i.state.roomMembers),debug:w,store:b(d.store),mainStoreId:S,meta:{sessionUID:e,uid:(o==null?void 0:o.uid)||(t==null?void 0:t.uid)||"",roomUUID:o==null?void 0:o.uuid,userPayload:b(t)}}})};p.add(()=>I(e=>{switch(e.NEAType){case"Init":{O();break}case"SetState":{P(e.payload);break}case"SetStore":{N(e.payload);break}case"SetPage":{k(e.payload);break}case"SendMagixMessage":{L(e.payload);break}case"MoveCamera":{A(e.payload);break}}})),a.emitter.on("destroy",()=>{m.log("destroy"),p.flushAll()}),u.src=d.src}};export{V as default};
