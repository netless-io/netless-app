import{n as V}from"./side-effect-manager.es.c07e661e.js";import{e as Q}from"./ensure-attributes.2c659353.js";const g=new WeakMap,E=new WeakMap,m=new WeakMap,C=Symbol("anyProducer"),U=Promise.resolve(),k=Symbol("listenerAdded"),D=Symbol("listenerRemoved");let v=!1;function y(t){if(typeof t!="string"&&typeof t!="symbol")throw new TypeError("eventName must be a string or a symbol")}function M(t){if(typeof t!="function")throw new TypeError("listener must be a function")}function S(t,e){const r=E.get(t);return r.has(e)||r.set(e,new Set),r.get(e)}function w(t,e){const r=typeof e=="string"||typeof e=="symbol"?e:C,i=m.get(t);return i.has(r)||i.set(r,new Set),i.get(r)}function X(t,e,r){const i=m.get(t);if(i.has(e))for(const s of i.get(e))s.enqueue(r);if(i.has(C)){const s=Promise.all([e,r]);for(const c of i.get(C))c.enqueue(s)}}function B(t,e){e=Array.isArray(e)?e:[e];let r=!1,i=()=>{},s=[];const c={enqueue(a){s.push(a),i()},finish(){r=!0,i()}};for(const a of e)w(t,a).add(c);return{async next(){return s?s.length===0?r?(s=void 0,this.next()):(await new Promise(a=>{i=a}),this.next()):{done:!1,value:await s.shift()}:{done:!0}},async return(a){s=void 0;for(const n of e)w(t,n).delete(c);return i(),arguments.length>0?{done:!0,value:await a}:{done:!0}},[Symbol.asyncIterator](){return this}}}function z(t){if(t===void 0)return G;if(!Array.isArray(t))throw new TypeError("`methodNames` must be an array of strings");for(const e of t)if(!G.includes(e))throw typeof e!="string"?new TypeError("`methodNames` element must be a string"):new Error(`${e} is not Emittery method`);return t}const x=t=>t===k||t===D;class b{static mixin(e,r){return r=z(r),i=>{if(typeof i!="function")throw new TypeError("`target` must be function");for(const a of r)if(i.prototype[a]!==void 0)throw new Error(`The property \`${a}\` already exists on \`target\``);function s(){return Object.defineProperty(this,e,{enumerable:!1,value:new b}),this[e]}Object.defineProperty(i.prototype,e,{enumerable:!1,get:s});const c=a=>function(...n){return this[e][a](...n)};for(const a of r)Object.defineProperty(i.prototype,a,{enumerable:!1,value:c(a)});return i}}static get isDebugEnabled(){if(typeof process!="object")return v;const{env:e}=process||{env:{}};return e.DEBUG==="emittery"||e.DEBUG==="*"||v}static set isDebugEnabled(e){v=e}constructor(e={}){g.set(this,new Set),E.set(this,new Map),m.set(this,new Map),this.debug=e.debug||{},this.debug.enabled===void 0&&(this.debug.enabled=!1),this.debug.logger||(this.debug.logger=(r,i,s,c)=>{c=JSON.stringify(c),typeof s=="symbol"&&(s=s.toString());const a=new Date,n=`${a.getHours()}:${a.getMinutes()}:${a.getSeconds()}.${a.getMilliseconds()}`;console.log(`[${n}][emittery:${r}][${i}] Event Name: ${s}
	data: ${c}`)})}logIfDebugEnabled(e,r,i){(b.isDebugEnabled||this.debug.enabled)&&this.debug.logger(e,this.debug.name,r,i)}on(e,r){M(r),e=Array.isArray(e)?e:[e];for(const i of e)y(i),S(this,i).add(r),this.logIfDebugEnabled("subscribe",i,void 0),x(i)||this.emit(k,{eventName:i,listener:r});return this.off.bind(this,e,r)}off(e,r){M(r),e=Array.isArray(e)?e:[e];for(const i of e)y(i),S(this,i).delete(r),this.logIfDebugEnabled("unsubscribe",i,void 0),x(i)||this.emit(D,{eventName:i,listener:r})}once(e){return new Promise(r=>{const i=this.on(e,s=>{i(),r(s)})})}events(e){e=Array.isArray(e)?e:[e];for(const r of e)y(r);return B(this,e)}async emit(e,r){y(e),this.logIfDebugEnabled("emit",e,r),X(this,e,r);const i=S(this,e),s=g.get(this),c=[...i],a=x(e)?[]:[...s];await U,await Promise.all([...c.map(async n=>{if(i.has(n))return n(r)}),...a.map(async n=>{if(s.has(n))return n(e,r)})])}async emitSerial(e,r){y(e),this.logIfDebugEnabled("emitSerial",e,r);const i=S(this,e),s=g.get(this),c=[...i],a=[...s];await U;for(const n of c)i.has(n)&&await n(r);for(const n of a)s.has(n)&&await n(e,r)}onAny(e){return M(e),this.logIfDebugEnabled("subscribeAny",void 0,void 0),g.get(this).add(e),this.emit(k,{listener:e}),this.offAny.bind(this,e)}anyEvent(){return B(this)}offAny(e){M(e),this.logIfDebugEnabled("unsubscribeAny",void 0,void 0),this.emit(D,{listener:e}),g.get(this).delete(e)}clearListeners(e){e=Array.isArray(e)?e:[e];for(const r of e)if(this.logIfDebugEnabled("clear",r,void 0),typeof r=="string"||typeof r=="symbol"){S(this,r).clear();const i=w(this,r);for(const s of i)s.finish();i.clear()}else{g.get(this).clear();for(const i of E.get(this).values())i.clear();for(const i of m.get(this).values()){for(const s of i)s.finish();i.clear()}}}listenerCount(e){e=Array.isArray(e)?e:[e];let r=0;for(const i of e){if(typeof i=="string"){r+=g.get(this).size+S(this,i).size+w(this,i).size+w(this).size;continue}typeof i<"u"&&y(i),r+=g.get(this).size;for(const s of E.get(this).values())r+=s.size;for(const s of m.get(this).values())r+=s.size}return r}bindMethods(e,r){if(typeof e!="object"||e===null)throw new TypeError("`target` must be an object");r=z(r);for(const i of r){if(e[i]!==void 0)throw new Error(`The property \`${i}\` already exists on \`target\``);Object.defineProperty(e,i,{enumerable:!1,value:this[i].bind(this)})}}}const G=Object.getOwnPropertyNames(b.prototype).filter(t=>t!=="constructor");Object.defineProperty(b,"listenerAdded",{value:k,writable:!1,enumerable:!0,configurable:!1});Object.defineProperty(b,"listenerRemoved",{value:D,writable:!1,enumerable:!0,configurable:!1});var Y=b;const Z=630,_=350;function q(t,e,r){return{sceneState:{sceneName:`${t}`,scenePath:`${r}/${t}`,contextPath:r,scenes:H(e),index:t-1}}}function H(t){const e=[];for(let r=1;r<=t;++r)e.push({name:String(r)});return e}function N(t){return Math.max(1,t-1)}function ee(t,e){return Math.min(e,t+1)}var d=(t=>(t.Init="Init",t.AttributesUpdate="AttributesUpdate",t.SetAttributes="SetAttributes",t.RegisterMagixEvent="RegisterMagixEvent",t.RemoveMagixEvent="RemoveMagixEvent",t.RemoveAllMagixEvent="RemoveAllMagixEvent",t.RoomStateChanged="RoomStateChanged",t.DispatchMagixEvent="DispatchMagixEvent",t.ReceiveMagixEvent="ReciveMagixEvent",t.NextPage="NextPage",t.PrevPage="PrevPage",t.SDKCreate="SDKCreate",t.OnCreate="OnCreate",t.SetPage="SetPage",t.GetAttributes="GetAttributes",t.Ready="Ready",t.Destroy="Destory",t.StartCreate="StartCreate",t.WrapperDidUpdate="WrapperDidUpdate",t.DisplayIframe="DisplayIframe",t.HideIframe="HideIframe",t.PageTo="PageTo",t))(d||{}),J=(t=>(t.WrapperDidMount="WrapperDidMount",t.IframeLoad="IframeLoad",t))(J||{});const ie={kind:"IframeBridge",setup(t){const e=t.box;e.setStageRatio(_/Z),t.getInitScenePath()&&t.createWhiteBoardView();const r=t.displayer,i=t.room,s=Q(t,{src:"about:blank",displaySceneDir:"/h5",lastEvent:null,state:{},page:0,maxPage:0}),c=new V,a=document.createElement("div");Object.assign(a.style,{width:"100%",height:"100%",position:"relative"});const n=document.createElement("iframe");Object.assign(n.style,{width:"100%",height:"100%",border:"none",display:"block"}),a.appendChild(n),e.mountContent(a);const R=l=>({...l,url:s.src,displaySceneDir:s.displaySceneDir,width:n.scrollWidth,height:n.scrollHeight,useClicker:!0,lastEvent:s.lastEvent}),h=new Y,A=new Map,L=()=>{A.forEach((l,u)=>{r.removeMagixEventListener(u,l)}),A.clear()},$=(...l)=>!1,f=l=>{var u;$("[IframeBridge] postMessage %s %O",l.kind,l.payload),(u=n.contentWindow)==null||u.postMessage(JSON.parse(JSON.stringify(l)),"*")},P=(l,u)=>{t.isWritable&&(t.updateAttributes(["lastEvent"],{name:l,payload:u}),i==null||i.dispatchMagixEvent(l,u))},O=()=>{f({kind:d.Init,payload:{attributes:R(s.state),roomState:r.state,currentPage:s.page,observerId:r.observerId}})};let T=s.src.includes("cocos");const W=l=>{O(),h.emit(J.IframeLoad,l),h.on(d.Ready,()=>{var u,o;(u=s.lastEvent)!=null&&u.payload&&f((o=s.lastEvent)==null?void 0:o.payload)}),T&&(setTimeout(()=>{f({kind:d.RoomStateChanged,payload:q(1,s.maxPage,s.displaySceneDir)})},500),T=!1),n.removeEventListener("load",W)};c.addEventListener(n,"load",W);let K=0;const F=()=>{K++<3&&(n.src=s.src)};c.addEventListener(n,"error",F),n.src=s.src,c.add(()=>t.mobxUtils.autorun(()=>{f({kind:d.AttributesUpdate,payload:R(s.state)})})),c.add(()=>t.mobxUtils.autorun(()=>{n.src=s.src})),c.add(()=>t.mobxUtils.autorun(()=>{f({kind:d.RoomStateChanged,payload:q(s.page,s.maxPage,s.displaySceneDir)})}));const j={emitter:h,postMessage:f,context:t};return h.emit(d.StartCreate),h.emit(d.OnCreate,j),c.addEventListener(window,"message",l=>{if(l.source!==n.contentWindow)return;const u=l.data;switch($("[IframeBridge] received",u.kind,u.payload),u.kind){case d.SetAttributes:{t.updateAttributes(["state"],{...s.state,...u.payload});break}case d.RegisterMagixEvent:{const o=I=>{I.authorId!==r.observerId&&f({kind:d.ReceiveMagixEvent,payload:I})},p=u.payload;A.set(p,o),r.addMagixEventListener(p,o);break}case d.RemoveMagixEvent:{const o=u.payload,p=A.get(o);r.removeMagixEventListener(o,p);break}case d.DispatchMagixEvent:{const o=u.payload;P(o.event,o.payload);break}case d.RemoveAllMagixEvent:{L();break}case d.NextPage:{if(t.isWritable&&i){const o=ee(s.page,s.maxPage);if(o===s.page)break;t.setScenePath([s.displaySceneDir,o].join("/")),t.updateAttributes(["page"],o),P(d.NextPage,{})}break}case d.PrevPage:{if(t.isWritable&&i){const o=N(s.page);if(o===s.page)break;t.setScenePath([s.displaySceneDir,o].join("/")),t.updateAttributes(["page"],o),P(d.PrevPage,{})}break}case d.SetPage:{const o=Number(u.payload)||0;if(t.isWritable&&i)if(!o)i.removeScenes(s.displaySceneDir);else{const p=i.entireScenes()[s.displaySceneDir];(!p||p.length!==o)&&(i.removeScenes(s.displaySceneDir),i.putScenes(s.displaySceneDir,H(o))),t.setScenePath(`${s.displaySceneDir}/1`),t.updateAttributes(["maxPage"],o)}break}case d.PageTo:{const o=u.payload;if(t.isWritable&&i){if(!Number.isSafeInteger(o)||o<=0)break;t.setScenePath(`${s.displaySceneDir}/${o}`),t.updateAttributes(["page"],o),P(d.PageTo,o-1)}break}case d.SDKCreate:{O();break}case d.GetAttributes:{f({kind:d.GetAttributes,payload:R(s.state)});break}default:console.warn(`[IframeBridge]: unknown event kind "${u.kind}"`)}}),t.emitter.on("destroy",()=>{console.log("[IframeBridge]: destroy"),h.emit(d.Destroy),c.flushAll(),L(),n.remove()}),j}};export{ie as default};
