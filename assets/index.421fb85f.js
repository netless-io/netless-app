var T=Object.defineProperty;var I=(o,t,i)=>t in o?T(o,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[t]=i;var r=(o,t,i)=>(I(o,typeof t!="symbol"?t+"":t,i),i);import{n as j}from"./side-effect-manager.es.c07e661e.js";import{e as A}from"./ensure-attributes.2c659353.js";let L;function V(o){if(window.GGBApplet)return Promise.resolve(window.GGBApplet);if(L)return L;{const t=document.createElement("script");if(L=new Promise((i,e)=>{t.onload=()=>i(window.GGBApplet),t.onerror=()=>{L=void 0,e()}}),o){const i=o.lastIndexOf("GeoGebra")+8;t.src=o.slice(0,i)+"/deployggb.js"}else t.src="https://www.geogebra.org/apps/deployggb.js";return document.head.appendChild(t),L}}const x={appName:"classic",showMenuBar:!0,showAlgebraInput:!0,showToolBar:!0,customToolBar:"0 39 73 62 | 1 501 67 , 5 19 , 72 75 76 | 2 15 45 , 18 65 , 7 37 | 4 3 8 9 , 13 44 , 58 , 47 | 16 51 64 , 70 | 10 34 53 11 , 24  20 22 , 21 23 | 55 56 57 , 12 | 36 46 , 38 49  50 , 71  14  68 | 30 29 54 32 31 33 | 25 17 26 60 52 61 | 40 41 42 , 27 28 35 , 6",showToolBarHelp:!1,showResetIcon:!1,enableFileFeatures:!1,enableLabelDrags:!1,enableShiftDragZoom:!0,enableRightClick:!0,errorDialogsActive:!1,allowStyleBar:!1,preventFocus:!1,useBrowserForJS:!0,language:"en",borderColor:"transparent"},u=class{constructor(t){r(this,"clientId");r(this,"nickName");r(this,"api");r(this,"context");r(this,"delay");r(this,"currentAnimations",[]);r(this,"embeds",{});r(this,"storageCallback",0);r(this,"initAllEmbeds",()=>{for(const t of this.api.getAllObjectNames("embed"))this.initEmbed(t)});r(this,"objectsInWaiting",[]);r(this,"updateCallback",0);r(this,"dispatchUpdates",()=>{this.updateCallback||(this.updateCallback=setTimeout(this._dispatchUpdates,this.delay))});r(this,"_dispatchUpdates",()=>{const{objectsInWaiting:t}=this;this.objectsInWaiting=[];for(const i of t){const e=this.api.getEmbeddedCalculators(!0),s=e==null?void 0:e[i];s!=null&&s.controller&&this.sendEvent("evalGMContent",s.toJSON(),i);const a=this.api.getCommandString(i,!1);if(a){this.sendEvent("evalCommand",`${i} := ${a}`,i);const n=this.api.getObjectsOfItsGroup(i);n!=null&&n.length&&this.sendEvent("addToGroup",i,n)}if(!a||this.api.isMoveable(i)){const n=this.api.getXML(i);this.sendEvent("evalXML",n,i)}this.sendEvent("select",i,!0)}this.updateCallback=0});r(this,"updateListener",t=>{(this.api.hasUnlabeledPredecessors(t)||this.api.isMoveable(t))&&!this.currentAnimations.includes(t)&&(this.objectsInWaiting.includes(t)||(this.objectsInWaiting.push(t),this.dispatchUpdates()))});r(this,"addListener",t=>{const i=this.api.getImageFileName(t);if(i){const n=this.api.getFileJSON();for(const d of n.archive)d.fileName.includes(i)&&this.sendEvent("addImage",JSON.stringify(d))}const e=this.api.getXML(t),a=this.api.getCommandString(t)&&this.api.getAlgorithmXML(t);this.sendEvent("addObject",a||e,t),this.sendEvent("deselect"),this.sendEvent("select",t,!0),setTimeout(()=>this.initEmbed(t),500)});r(this,"removeListener",t=>{this.sendEvent("deleteObject",t),delete this.embeds[t]});r(this,"renameListener",(t,i)=>{this.sendEvent("renameObject",t,i)});r(this,"lastEditingLabel");r(this,"isSyncingViewState",0);r(this,"stopSyncViewState",()=>{this.isSyncingViewState=0});r(this,"_flushViewState",()=>{const{invXscale:t,invYscale:i,xMin:e,yMin:s}=JSON.parse(this.api.getViewProperties(0)),a=1/t,n=-e/t,d=-s/i;return this.viewState={scale:a,x:n,y:d},this.viewSyncCallback=0,this.viewState});r(this,"clientListener",t=>{let i,e;const s=t.type;switch(s){case"updateStyle":i=t.target,e=this.api.getXML(i),this.sendEvent("evalXML",e);break;case"editorStart":this.lastEditingLabel=t.target;break;case"editorKeyTyped":e=this.api.getEditorState(),this.sendEvent("setEditorState",e,this.lastEditingLabel);break;case"editorStop":this.lastEditingLabel=void 0,this.sendEvent("setEditorState",JSON.stringify({content:""}));break;case"deselect":this.sendEvent("deselect",t.target);break;case"select":this.sendEvent("select",t.target);break;case"embeddedContentChanged":i=t[1],e=t[2],this.sendEvent("embeddedContentChanged",e,i);break;case"undo":case"redo":case"addPolygonComplete":e=this.api.getXML(),this.sendEvent("setXML",e);break;case"addSlide":this.sendEvent(s);break;case"removeSlide":case"moveSlide":case"selectSlide":case"clearSlide":case"orderingChange":e=t[2],this.sendEvent(s,e);break;case"pasteSlide":({cardIdx:e,ggbFile:i}=t),this.sendEvent(s,e,i);break;case"startAnimation":i=t[1],this.currentAnimations.push(i),this.sendEvent(s,i,i);break;case"stopAnimation":i=t[1],this.currentAnimations.splice(this.currentAnimations.indexOf(i),1),this.sendEvent(s,i,i);break;case"groupObjects":case"ungroupObjects":e=t.targets,this.sendEvent(s,e);break;case"pasteElmsComplete":e=t.targets.map(a=>this.api.getXML(a)).join(""),this.sendEvent("evalXML",e);break;case"addGeoToTV":case"removeGeoFromTV":e=t[1],this.sendEvent(s,e);break;case"setValuesOfTV":e=t[2],this.sendEvent(s,e);break;case"showPointsTV":({column:e,show:i}=t),this.sendEvent(s,e,i);break;case"lockTextElement":case"unlockTextElement":e=t[1],this.sendEvent(s,e);break;case"viewChanged2D":this.viewSyncCallback||(this.isSyncingViewState||this.viewState.scale===0?this.viewSyncCallback=setTimeout(this._flushViewState,this.delay):this.viewSyncCallback=setTimeout(this._sendViewSyncEvent,this.delay));break;case"mouseDown":case"deleteGeos":case"dragEnd":break;default:console.debug("[GeoGebra] unhandled event ",t.type,t)}});r(this,"viewSyncCallback",0);r(this,"viewState",{scale:0,x:0,y:0});r(this,"_sendViewSyncEvent",()=>{this._flushViewState(),this.sendEvent("viewChanged2D",JSON.stringify(this.viewState)),this.viewSyncCallback=0});r(this,"_delayedRegisterListeners",()=>{this.registerListeners(),this.viewSyncCallback=0});r(this,"conflictedObjects",[]);r(this,"dispatch",t=>{var d,g;if(this.conflictedObjects.includes(t.label)&&t.type!=="conflictResolution")return;const e=t.embedLabel?this.embeds[t.embedLabel]:this,s=t.type,a=t.label,n=t.content;if(console.debug("[GeoGebra] receive:",s,a,n),s==="addObject")if(e.api.exists(a))if(this.context.isDecider)if(this.context.isDecider(this.clientId)){let l=1,c;do c=`${a}_${l}`,l++;while(e.api.exists(c));this.unregisterListeners(),e.api.renameObject(a,c),this.registerListeners();const p=e.api.getAlgorithmXML(c)||e.api.getXML(c);this.sendEvent("conflictResolution",p,a)}else this.conflictedObjects.push(a);else e.evalXML(n),e.api.previewRefresh();else e.evalXML(n),e.api.previewRefresh();else if(s==="conflictResolution"){const l=this.conflictedObjects.indexOf(a);l!==-1&&this.conflictedObjects.splice(l,1),e.evalXML(n),e.api.previewRefresh()}else if(s==="evalXML")e.evalXML(n),e.api.previewRefresh();else if(s==="setXML")e.setXML(n);else if(s==="evalCommand")e.evalCommand(n),e.api.previewRefresh();else if(s==="deleteObject")e.unregisterListeners(),e===this&&delete this.embeds[n],e.api.deleteObject(n),e.registerListeners();else if(s==="setEditorState")e.unregisterListeners(),e.api.setEditorState(n,a),e.registerListeners();else if(s==="addImage"){const l=JSON.parse(n);e.api.addImage(l.fileName,l.fileContent)}else if(["addSlide","removeSlide","moveSlide","clearSlide"].includes(s))e.api.handleSlideAction(s,n);else if(s==="selectSlide")e.unregisterListeners(),e.api.selectSlide(n),e.registerListeners();else if(s==="renameObject")e.unregisterListeners(),e.api.renameObject(n,a),e.registerListeners();else if(s==="pasteSlide")e.api.handleSlideAction(s,n,a);else if(s==="evalGMContent"){const l=(e.api.getEmbeddedCalculators(!0)||{})[a];l&&l.loadFromJSON(n)}else if(s==="startAnimation")e.api.setAnimating(a,!0),e.api.startAnimation();else if(s==="stopAnimation")e.api.setAnimating(a,!1);else if(s==="select"){if(n){const l=((g=(d=this.context).getColor)==null?void 0:g.call(d,t.clientId))||"#80808080";e.api.addMultiuserSelection(String(t.nickName),l,n,!!a)}}else if(s==="deselect")e.api.removeMultiuserSelections(String(t.nickName));else if(s==="orderingChange")e.api.updateOrdering(n);else if(s==="groupObjects")e.api.groupObjects(n);else if(s==="ungroupObjects")e.api.ungroupObjects(n);else if(s==="addToGroup")e.api.addToGroup(n,a);else if(s==="embeddedContentChanged")e.api.setEmbedContent(a,n);else if(s==="addGeoToTV")e.api.addGeoToTV(n);else if(s==="setValuesOfTV")e.api.setValuesOfTV(n);else if(s==="removeGeoFromTV")e.api.removeGeoFromTV(n);else if(s==="showPointsTV")e.api.showPointsTV(n,a);else if(s==="lockTextElement")e.api.lockTextElement(n);else if(s==="unlockTextElement")e.api.unlockTextElement(n);else if(s==="viewChanged2D")if(e.viewState.scale===0)e.api.evalCommand("Pan(0,0)"),e.startSyncViewState();else{const{scale:l,x:c,y:p}=JSON.parse(n),h=e._flushViewState();e.startSyncViewState(),e.api.evalCommand(`Pan(${c-h.x},${p-h.y})`),e.api.evalCommand(`ZoomIn(${l/h.scale})`)}else console.debug("[GeoGebra] unknown event",s,n,a)});var i;this.api=t.api,this.clientId=t.clientId,this.nickName=t.nickName,this.delay=(i=t.delay)!=null?i:200,this.context=t,setTimeout(()=>{this.api.evalCommand("Pan(0,0)")},this.delay)}createEvent(t,i,e){const s={type:t,content:i,clientId:this.clientId,nickName:this.nickName};return this.context.embedLabel&&(s.embedLabel=this.context.embedLabel),e&&(s.label=e),s}sendEvent(t,i,e){console.log("[GeoGebra] send:",t,e,i),this.context.postMessage(this.createEvent(t,i,e)),this.storageCallback||(this.storageCallback=setTimeout(()=>{this.context.save(this.api.getBase64()),this.storageCallback=0},this.delay))}evalCommand(t){this.unregisterListeners(),this.api.evalCommand(t),this.registerListeners()}evalXML(t){this.unregisterListeners(),this.api.evalXML(t),this.api.updateConstruction(),this.registerListeners(),setTimeout(this.initAllEmbeds,500)}setXML(t){this.unregisterListeners(),this.api.setXML(t),this.api.updateConstruction(),this.registerListeners()}initEmbed(t){if(this.embeds[t])return;const i=this.api.getEmbeddedCalculators();if(!i)return;const e=i[t];if(e&&"registerClientListener"in e){const s=new u({...this.context,clientId:this.clientId,nickName:this.nickName,api:e,embedLabel:t});s.registerListeners(),this.embeds[t]=s}}startSyncViewState(){clearTimeout(this.isSyncingViewState),this.isSyncingViewState=setTimeout(this.stopSyncViewState,1e3)}shouldSyncView(t,i,e,s){return Math.abs(i-t.scale)>u.Threshold/10||Math.abs(e-t.x)>u.Threshold||Math.abs(s-t.y)>u.Threshold}registerListeners(){this.api.registerUpdateListener(this.updateListener),this.api.registerRemoveListener(this.removeListener),this.api.registerAddListener(this.addListener),this.api.registerClientListener(this.clientListener),this.api.registerRenameListener(this.renameListener)}unregisterListeners(){this.api.unregisterUpdateListener(this.updateListener),this.api.unregisterRemoveListener(this.removeListener),this.api.unregisterAddListener(this.addListener),this.api.unregisterClientListener(this.clientListener),this.api.unregisterRenameListener(this.renameListener)}};let S=u;r(S,"Threshold",20);const N=`.netless-app-geogebra{width:100%!important;height:100%!important;overflow:hidden}.netless-app-geogebra.loading{background-color:#fff}.netless-app-geogebra.readonly{user-select:none;pointer-events:none}
`;function X(o,t){const i=new ResizeObserver(()=>t(o));return i.observe(o),()=>i.disconnect()}function B(o,t,i){const e=o.displayer,s=o.room;let a=[];const n=c=>{c.authorId!==e.observerId&&a.forEach(p=>p(c.payload))},d="sync--"+o.appId;return e.addMagixEventListener(d,n),{service:{addListener(c){a.push(c)},postMessage(c){s==null||s.dispatchMagixEvent(d,c)},load(){return t[i]},save(c){o.updateAttributes([i],c)}},disposer:()=>{a=[],e.removeMagixEventListener(d)}}}const J={kind:"GeoGebra",config:{enableShadowDOM:!1},async setup(o){var C,k;const t=o.displayer,i=t.observerId,e=(C=t.state.roomMembers.find(m=>m.memberId===i))==null?void 0:C.payload,s=(e==null?void 0:e.uid)||"",a=(e==null?void 0:e.nickName)||s,n=(k=o.getAppOptions())==null?void 0:k.HTML5Codebase,d=A(o,{uid:"",ggbBase64:""}),g=o.box;g.mountStyles(N);const l=document.createElement("div");l.classList.add("netless-app-geogebra","loading"),s!==d.uid&&d.uid&&l.classList.add("netless-app-geogebra","readonly"),g.mountContent(l);const c=new j,p={...x};p.language=navigator.language.startsWith("zh")?"zh":"en",d.ggbBase64&&(p.ggbBase64=d.ggbBase64),p.id="ggb_"+o.appId;let h;const w=B(o,d,"ggbBase64");function E(){const{width:m,height:b}=l.getBoundingClientRect();h==null||h.setWidth(m),h==null||h.setHeight(b)}p.appletOnLoad=m=>{console.log(`[GeoGebra]: loaded ${JSON.stringify(p.id)}`),h=m,E(),l.classList.remove("loading");const b=o.displayer,M=new S({clientId:b.observerId,nickName:a,api:m,isDecider:f=>b.state.roomMembers.map(v=>v.memberId).every(v=>f<=v),getColor:f=>{const O=b.memberState(f).strokeColor;return"#"+O.map(v=>v.toString(16).padStart(2,"0")).join("")+"80"},...w.service});M.registerListeners(),w.service.addListener(f=>{M.dispatch(f),h==null||h.setUndoPoint()})},c.add(()=>X(l,E)),o.emitter.on("destroy",()=>{console.log("[GeoGebra]: destroy"),c.flushAll(),w.disposer(),h==null||h.remove()});const G=await V(n),y=new G(p);n&&y.setHTML5Codebase(n),y.inject(l)}};export{J as default};
