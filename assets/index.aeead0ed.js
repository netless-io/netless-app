var S=Object.defineProperty;var k=(e,t,r)=>t in e?S(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var p=(e,t,r)=>(k(e,typeof t!="symbol"?t+"":t,r),r);import{n as $}from"./side-effect-manager.es.c07e661e.js";function A(){return new Worker(""+new URL("fit-curve-worker.4d94c30e.js",import.meta.url).href)}let E=(e=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let n=r[e]&63;n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n<63?t+="_":t+="-"}return t};function M(){return new Worker(""+new URL("bezier-q.8fae6e32.js",import.meta.url).href)}function I(){return document.createElementNS("http://www.w3.org/2000/svg","svg")}function g(){return document.createElementNS("http://www.w3.org/2000/svg","path")}function v(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function b(e,t){const{left:r,top:n}=t.getBoundingClientRect();return{x:e.clientX-r|0,y:e.clientY-n|0}}const P=({x:e,y:t})=>`M${e},${t}`,y=({x:e,y:t})=>`L${e},${t}`,x=(e,{x:t,y:r})=>`Q${e.x},${e.y} ${t},${r}`,W=(e,t,{x:r,y:n})=>`C${e.x},${e.y} ${t.x},${t.y} ${r} ${n}`;class D{constructor(t){this.path=t}remove(){this.path.remove()}}class j extends D{replace(t){if(t.length<2)this.path.setAttribute("d","");else{const r=t.length-1;let n=P(t[0])+y(v(t[0],t[1]));for(let s=1;s<r;++s)n+=x(t[s],v(t[s],t[s+1]));n+=y(t[r]),this.path.setAttribute("d",n)}}}class R extends D{replace(t){if(t.length<1)this.path.setAttribute("d","");else{const r=t.length-1;let n=P(t[0][0]);for(let s=0;s<=r;++s){const l=t[s];n+=W(l[1],l[2],l[3])}this.path.setAttribute("d",n)}}}const V=3,C=new M,L=new Map,F=()=>new Promise(e=>requestAnimationFrame(e));C.onmessage=e=>{const{id:t,points:r}=e.data,n=L.get(t);n&&n(r)};async function B(e,t){const r=e.newPath(),{length:n}=t;for(let s=2;s<n;++s)r.replace(t.slice(0,s)),await F();r.replace(t)}function G(e,t){t=t.map(n=>n.map(s=>({...s})));const r=E();L.set(r,n=>B(e,n)),C.postMessage({id:r,curves:t,step:V})}class m{constructor(t,r,n){p(this,"currentPathUID","");p(this,"pointerDown",t=>{t.isPrimary&&(this.target.setPointerCapture(t.pointerId),this.currentPathUID=E(),this.onDraw(this.currentPathUID,b(t,this.target),t.timeStamp))});p(this,"pointerMove",t=>{t.isPrimary&&this.currentPathUID&&this.onDraw(this.currentPathUID,b(t,this.target),t.timeStamp)});p(this,"pointerUp",t=>{this.currentPathUID&&(this.onDrawEnd(this.currentPathUID,t.timeStamp),this.currentPathUID="",this.target.releasePointerCapture(t.pointerId))});this.target=t,this.onDraw=r,this.onDrawEnd=n,t.addEventListener("pointerdown",this.pointerDown,!1),t.addEventListener("pointermove",this.pointerMove,!1),t.addEventListener("pointerup",this.pointerUp,!1),t.addEventListener("pointerleave",this.pointerUp,!1)}clear(){let t=null;for(;t=this.target.firstChild;)t.remove()}destroy(){this.target.removeEventListener("pointerdown",this.pointerDown,!1),this.target.removeEventListener("pointermove",this.pointerMove,!1),this.target.removeEventListener("pointerup",this.pointerUp,!1),this.target.removeEventListener("pointerleave",this.pointerUp,!1)}newPath(){const t=g();return this.target.append(t),new j(t)}newCurve(){const t=g();return this.target.append(t),new R(t)}initCurves(t){for(const r of Object.values(t))this.newCurve().replace(r)}}p(m,"createSVGElement",I);const q={kind:"Paint",setup(e){const t=e.box,r=e.createStorage("curves",e.attributes.curves||{}),n=m.createSVGElement();n.setAttribute("fill","transparent"),n.setAttribute("stroke",t.darkMode?"#fff":"#000"),n.setAttribute("stroke-width","2"),Object.assign(n.style,{display:"block",width:"100%",height:"100%",touchAction:"none"}),t.mountContent(n);const s=new $;s.addDisposer(t.onValChanged("darkMode",i=>{n.setAttribute("stroke",i?"#fff":"#000")}));const l=new A,w=i=>{e.isWritable&&e.dispatchMagixEvent("broadcast",i)},d={};s.addDisposer(e.addMagixEventListener("broadcast",({authorId:i,payload:a})=>{if(i===e.displayer.observerId)return;const{clear:h,pid:o,done:U}=a;h&&(c.clear(),c.initCurves(r.state)),o&&U&&G(c,r.state[o])}));const c=new m(n,(i,a,h)=>{let o=d[i];o||(o=d[i]={points:[],path:c.newPath()}),o.points.push(a),o.path.replace(o.points),o.timeStamp=h},i=>{const a=d[i];!a||(a.points.length<2?a.path.remove():l.postMessage({id:i,path:a.points,error:5}),delete d[i])});c.initCurves(r.state),l.onmessage=i=>{const{id:a,curves:h}=i.data;e.isWritable&&(r.setState({[a]:h}),w({pid:a,done:!0}))};const u=document.createElement("button");u.classList.add("netless-app-paint-clear-btn"),u.textContent="CLEAR ALL",u.addEventListener("click",()=>{c.clear(),r.resetState(),w({clear:!0})});const f=document.createElement("div");f.append(u),Object.assign(f.style,{display:"flex",justifyContent:"center"}),t.mountFooter(f),e.emitter.on("destroy",()=>{console.log("[Paint]: destroy"),s.flushAll(),c.destroy()})}};export{q as default};
