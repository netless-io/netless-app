var U=Object.defineProperty;var k=(e,t,r)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var p=(e,t,r)=>(k(e,typeof t!="symbol"?t+"":t,r),r);import{o as $}from"./index-13a0c33f.js";import"./modulepreload-polyfill-ec808ebb.js";function A(){return new Worker(""+new URL("fit-curve-worker-f5215ef2.js",import.meta.url).href)}let b=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,r)=>(r&=63,r<36?t+=r.toString(36):r<62?t+=(r-26).toString(36).toUpperCase():r>62?t+="-":t+="_",t),"");function M(){return new Worker(""+new URL("bezier-q-aac5b78d.js",import.meta.url).href)}function I(){return document.createElementNS("http://www.w3.org/2000/svg","svg")}function g(){return document.createElementNS("http://www.w3.org/2000/svg","path")}function v(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function E(e,t){const{left:r,top:n}=t.getBoundingClientRect();return{x:e.clientX-r|0,y:e.clientY-n|0}}const D=({x:e,y:t})=>`M${e},${t}`,P=({x:e,y:t})=>`L${e},${t}`,x=(e,{x:t,y:r})=>`Q${e.x},${e.y} ${t},${r}`,W=(e,t,{x:r,y:n})=>`C${e.x},${e.y} ${t.x},${t.y} ${r} ${n}`;class C{constructor(t){this.path=t}remove(){this.path.remove()}}class j extends C{replace(t){if(t.length<2)this.path.setAttribute("d","");else{const r=t.length-1;let n=D(t[0])+P(v(t[0],t[1]));for(let s=1;s<r;++s)n+=x(t[s],v(t[s],t[s+1]));n+=P(t[r]),this.path.setAttribute("d",n)}}}class R extends C{replace(t){if(t.length<1)this.path.setAttribute("d","");else{const r=t.length-1;let n=D(t[0][0]);for(let s=0;s<=r;++s){const l=t[s];n+=W(l[1],l[2],l[3])}this.path.setAttribute("d",n)}}}const V=3,L=new M,y=new Map,F=()=>new Promise(e=>requestAnimationFrame(e));L.onmessage=e=>{const{id:t,points:r}=e.data,n=y.get(t);n&&n(r)};async function B(e,t){const r=e.newPath(),{length:n}=t;for(let s=2;s<n;++s)r.replace(t.slice(0,s)),await F();r.replace(t)}function G(e,t){t=t.map(n=>n.map(s=>({...s})));const r=b();y.set(r,n=>B(e,n)),L.postMessage({id:r,curves:t,step:V})}class m{constructor(t,r,n){p(this,"currentPathUID","");p(this,"pointerDown",t=>{t.isPrimary&&(this.target.setPointerCapture(t.pointerId),this.currentPathUID=b(),this.onDraw(this.currentPathUID,E(t,this.target),t.timeStamp))});p(this,"pointerMove",t=>{t.isPrimary&&this.currentPathUID&&this.onDraw(this.currentPathUID,E(t,this.target),t.timeStamp)});p(this,"pointerUp",t=>{this.currentPathUID&&(this.onDrawEnd(this.currentPathUID,t.timeStamp),this.currentPathUID="",this.target.releasePointerCapture(t.pointerId))});this.target=t,this.onDraw=r,this.onDrawEnd=n,t.addEventListener("pointerdown",this.pointerDown,!1),t.addEventListener("pointermove",this.pointerMove,!1),t.addEventListener("pointerup",this.pointerUp,!1),t.addEventListener("pointerleave",this.pointerUp,!1)}clear(){let t=null;for(;t=this.target.firstChild;)t.remove()}destroy(){this.target.removeEventListener("pointerdown",this.pointerDown,!1),this.target.removeEventListener("pointermove",this.pointerMove,!1),this.target.removeEventListener("pointerup",this.pointerUp,!1),this.target.removeEventListener("pointerleave",this.pointerUp,!1)}newPath(){const t=g();return this.target.append(t),new j(t)}newCurve(){const t=g();return this.target.append(t),new R(t)}initCurves(t){for(const r of Object.values(t))this.newCurve().replace(r)}}p(m,"createSVGElement",I);const z={kind:"Paint",setup(e){const t=e.box,r=e.createStorage("curves",e.attributes.curves||{}),n=m.createSVGElement();n.setAttribute("fill","transparent"),n.setAttribute("stroke",t.darkMode?"#fff":"#000"),n.setAttribute("stroke-width","2"),Object.assign(n.style,{display:"block",width:"100%",height:"100%",touchAction:"none"}),t.mountContent(n);const s=new $;s.addDisposer(t.onValChanged("darkMode",a=>{n.setAttribute("stroke",a?"#fff":"#000")}));const l=new A,w=a=>{e.isWritable&&e.dispatchMagixEvent("broadcast",a)},d={};s.addDisposer(e.addMagixEventListener("broadcast",({authorId:a,payload:i})=>{if(a===e.displayer.observerId)return;const{clear:h,pid:o,done:S}=i;h&&(c.clear(),c.initCurves(r.state)),o&&S&&G(c,r.state[o])}));const c=new m(n,(a,i,h)=>{let o=d[a];o||(o=d[a]={points:[],path:c.newPath()}),o.points.push(i),o.path.replace(o.points),o.timeStamp=h},a=>{const i=d[a];i&&(i.points.length<2?i.path.remove():l.postMessage({id:a,path:i.points,error:5}),delete d[a])});c.initCurves(r.state),l.onmessage=a=>{const{id:i,curves:h}=a.data;e.isWritable&&(r.setState({[i]:h}),w({pid:i,done:!0}))};const u=document.createElement("button");u.classList.add("netless-app-paint-clear-btn"),u.textContent="CLEAR ALL",u.addEventListener("click",()=>{c.clear(),r.resetState(),w({clear:!0})});const f=document.createElement("div");f.append(u),Object.assign(f.style,{display:"flex",justifyContent:"center"}),t.mountFooter(f),e.emitter.on("destroy",()=>{console.log("[Paint]: destroy"),s.flushAll(),c.destroy()})}};export{z as default};
