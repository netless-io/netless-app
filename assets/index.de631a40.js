var I=Object.defineProperty;var A=(t,e,r)=>e in t?I(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var f=(t,e,r)=>(A(t,typeof e!="symbol"?e+"":e,r),r);import{_ as y,A as N,m as x,y as b,h as _,e as m,S as W}from"./hooks.module.ea4857d9.js";import{c as D}from"./clsx.m.f2bc012f.js";function z(t){return`netless-app-gomoku-${t}`}function E(t,e){var o;return(((o=t.find(s=>s.uid===e))==null?void 0:o.payload)||{}).nickName||e}const O=15;function F(t,e,r){const o=t[e][r];if(o==="")return"";let s;s=1;for(let n=e;t[n+1]&&t[++n][r]===o;)++s;for(let n=e;t[n-1]&&t[--n][r]===o;)++s;if(s>=5)return o;s=1;for(let n=r;t[e][n+1]&&t[e][++n]===o;)++s;for(let n=r;t[e][n-1]&&t[e][--n]===o;)++s;if(s>=5)return o;s=1;for(let n=e,i=r;t[n+1]&&t[++n][--i]===o;)++s;for(let n=e,i=r;t[n-1]&&t[--n][++i]===o;)++s;if(s>=5)return o;s=1;for(let n=e,i=r;t[n+1]&&t[++n][++i]===o;)++s;for(let n=e,i=r;t[n-1]&&t[--n][--i]===o;)++s;return s>=5?o:""}function R(t){return Object.keys(t).map(Number).sort()}function T(){return Array.from({length:O},()=>Array(O).fill(""))}function G(t){const e=T();for(const r of R(t)){const{i:o,j:s,c:n}=t[r];e[o][s]=n;const i=F(e,o,s);if(i)return i}return""}function $(t){const e=T();return R(t).forEach(r=>{const{c:o,i:s,j:n}=t[r];e[s][n]=o}),e}function j(t){return Object.keys(t).reduce((e,r)=>Math.max(e,Number(r)),-1)+1}const Y={xPlayer:null,oPlayer:null,turn:"o"};function q(t){const[e,r]=x(()=>t.isWritable);return b(()=>t.emitter.on("writableChange",()=>r(t.isWritable)),[t]),e}function B(t,e,r){const[o]=x(()=>t.createStorage(e,r())),[s,n]=x(o.state),i=y(()=>o.setState.bind(o),[t]);return b(()=>o.on("stateChanged",()=>{n({...o.state})}),[o]),[s,i]}function J(t){const[e,r]=x(()=>t.members);return b(()=>t.emitter.on("roomMembersChange",r),[t]),e}function K(t){return y(()=>{var e;return((e=t.currentMember)==null?void 0:e.uid)||""},[t])}function U(t){const[e,r]=B(t,"gomoku",()=>Y),[o,s]=B(t,"operations",()=>({})),n=q(t),i=J(t),c=K(t),k=y(()=>$(o),[o]),[l,u]=y(()=>{const a=G(o);return a?a==="o"?[e.oPlayer,e.xPlayer]:[e.xPlayer,e.oPlayer]:[null,null]},[o,e.oPlayer,e.xPlayer]),[C,g]=y(()=>{const a=l&&(E(i,l)||l),h=u&&(E(i,u)||u);return[a,h]},[i,l,u]),M=y(()=>n?e.oPlayer&&e.oPlayer===c?e.turn!=="o":e.xPlayer&&e.xPlayer===c?e.turn!=="x":Boolean(e.oPlayer&&e.xPlayer):!0,[e.oPlayer,e.xPlayer,e.turn,c,n]),P=y(()=>!n||e.oPlayer===c||e.xPlayer===c?!1:!e.oPlayer||!e.xPlayer,[e.xPlayer,e.oPlayer,c,n]),w=y(()=>l!==null?!1:e.oPlayer===c&&!e.xPlayer||e.xPlayer===c&&!e.oPlayer,[e.xPlayer,e.oPlayer,c]),v=N(()=>{e.oPlayer?e.xPlayer||r({xPlayer:c}):r({oPlayer:c})},[e.oPlayer,e.xPlayer,c]),d=N((a,h)=>{if(n){const p={i:a,j:h,c:e.turn};s({[j(o)]:p}),r({turn:e.turn==="o"?"x":"o"})}},[o,e.turn]);return{board:k,turn:e.turn,readonly:M,winner:l,loser:u,winnerName:C,loserName:g,memberID:c,isShowLogin:P,isShowWaiting:w,onLogin:v,onOperation:d}}class S{constructor(e,r){this.row=e,this.col=r}}function L(){}function Z(t,e,r){return t.row!==e||t.col!==r}function H(t){t.resetTransform?t.resetTransform():t.setTransform(1,0,0,1,0,0)}class Q{constructor(){f(this,"padding",12);f(this,"rows",15);f(this,"cellSize",30);f(this,"$container",null);f(this,"board",[]);f(this,"cursor",new S(-1,-1));f(this,"color","");f(this,"resizeObserver",null);f(this,"disposers",new Set);f(this,"onClick",L);f(this,"onPointerMove",({clientX:e,clientY:r})=>{const{left:o,top:s}=this.canvas.getBoundingClientRect(),n=Math.round((e-o-this.padding)/this.cellSize),i=Math.round((r-s-this.padding)/this.cellSize);this.setCursor(n,i)});f(this,"tryMove",()=>{if(this.hasCursor()&&this.color!==""){const{row:e,col:r}=this.cursor;this.onClick(e,r)}});this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d")}mount(e){if(this.$container=e,e){e.appendChild(this.canvas),e.addEventListener("pointermove",this.onPointerMove),e.addEventListener("click",this.tryMove);const r=new ResizeObserver(this.refresh.bind(this));this.resizeObserver=r,r.observe(e),this.disposers.add(()=>{e.removeEventListener("pointermove",this.onPointerMove),e.removeEventListener("click",this.tryMove),r.disconnect()}),this.refresh()}return this.unmount.bind(this)}unmount(){this.disposers.forEach(e=>e()),this.disposers.clear(),this.cursor=new S(-1,-1),this.board=[],this.onClick=L,this.$container=null,this.resizeObserver=null}setBoard(e){this.board!==e&&(this.board=e,this.refresh())}onOperation(e){this.onClick=e}setCursor(e,r){Z(this.cursor,e,r)&&(this.cursor=new S(e,r),this.refresh())}setColor(e){this.color!==e&&(this.color=e,this.refresh())}refresh(){if(!this.$container)return;const{$container:e,canvas:r,context:o}=this,{width:s,height:n}=e.getBoundingClientRect(),i=Math.min(s,n);r.style.width=r.style.height=`${i}px`;const c=window.devicePixelRatio,k=Math.floor(i*c);r.width=r.height=k,H(o),o.scale(c,c);const l=this.padding,u=i-l*2,C=this.rows,g=u/(C-1),M=g/Math.E;this.cellSize=g,o.fillStyle="#FF851B",o.fillRect(0,0,k,k),o.strokeStyle="#000",o.lineWidth=4,o.lineJoin="round",o.strokeRect(l,l,u,u),o.fillRect(l,l,u,u),o.lineWidth=1,o.beginPath();for(let d=1;d<=C-2;++d){const a=l+d*g;o.moveTo(l,a),o.lineTo(l+u,a),o.moveTo(a,l),o.lineTo(a,l+u)}o.stroke(),o.fillStyle="#000",o.beginPath();for(const d of[3,11])for(const a of[3,11]){const h=l+d*g,p=l+a*g;o.moveTo(h,p),o.ellipse(h,p,2,2,0,0,2*Math.PI)}o.fill();const P=[],w=[];this.board.forEach((d,a)=>{d.forEach((h,p)=>{h==="o"&&P.push(new S(a,p)),h==="x"&&w.push(new S(a,p))})}),o.lineWidth=2,o.strokeStyle="#000";const v=({row:d,col:a})=>{const h=d*g+l,p=a*g+l;o.moveTo(h,p),o.ellipse(h,p,M,M,0,0,2*Math.PI)};w.length&&(o.fillStyle="#000",o.beginPath(),w.forEach(v),o.stroke(),o.fill()),P.length&&(o.fillStyle="#fff",o.beginPath(),P.forEach(v),o.stroke(),o.fill()),this.color&&this.hasCursor()&&(o.strokeStyle="transparent",o.fillStyle=this.color==="o"?"#ffffff70":"#00000070",o.beginPath(),v(this.cursor),o.stroke(),o.fill())}hasCursor(){const{row:e,col:r}=this.cursor;return this.board[e]&&this.board[e][r]===""}}function V({board:t,turn:e,readonly:r,onOperation:o}){const s=_(null),[n]=x(()=>new Q);return b(()=>n.mount(s.current),[n]),b(()=>n.setBoard(t),[t]),b(()=>n.setColor(e),[e]),b(()=>n.onOperation(o),[o]),m("div",{className:D(z("board"),{"is-readonly":r}),ref:s})}function X({onLogin:t}){return m("div",{className:z("login"),children:m("button",{className:z("login-start"),onClick:t,children:"Start"})})}function ee(){return m("div",{className:z("waiting"),children:"Waiting for other players\u2026"})}function te({memberID:t,winner:e,loser:r}){return!e&&!r?null:m("div",{className:z("winner"),children:t===e?"You Win!":t===r?"You Lose!":`${e} Wins!`})}function oe({context:t}){const e=U(t);return m("div",{class:"netless-app-gomoku",children:[m(V,{board:e.board,readonly:e.readonly,turn:e.turn,onOperation:e.onOperation}),e.isShowLogin&&m(X,{onLogin:e.onLogin}),e.isShowWaiting&&m(ee,{}),(e.winner||e.loser)&&m(te,{winner:e.winnerName,loser:e.loserName,memberID:e.memberID})]})}const re=`.netless-app-gomoku-container,.netless-app-gomoku,.netless-app-gomoku-board{width:100%;height:100%;overflow:hidden;box-sizing:border-box;position:relative}.netless-app-gomoku-board{font-size:0;text-align:center;cursor:default}.netless-app-gomoku-board canvas{cursor:pointer}.netless-app-gomoku-board.is-readonly{pointer-events:none}.netless-app-gomoku-board.is-readonly canvas{cursor:default}.netless-app-gomoku-login{position:absolute;z-index:100;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;background:#ffbe76}.netless-app-gomoku-login-start{border:0;background:#f0932b;width:100%;height:50%;cursor:pointer;font-size:20px;color:#fff}.netless-app-gomoku-winner{position:absolute;z-index:101;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f39c12;color:#fff;font-size:50px}.netless-app-gomoku-waiting{position:absolute;z-index:101;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f39c12;color:#fff;font-size:30px}
`,le={kind:"Gomoku",config:{minwidth:.3,minheight:.3,width:9/16*.5,height:.5},setup(t){t.box.mountStyles(re);const e=document.createElement("div");e.className="netless-app-gomoku-container",t.box.mountContent(e),W(m(oe,{context:t}),e),t.emitter.on("destroy",()=>{W(null,e)})}};export{le as default};
