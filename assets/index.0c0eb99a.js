var S=Object.defineProperty;var R=(e,t,s)=>t in e?S(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var c=(e,t,s)=>(R(e,typeof t!="symbol"?t+"":t,s),s);import{n as $}from"./side-effect-manager.es.c07e661e.js";import{a0 as L}from"./index.88f12c1b.js";import{L as M}from"./logger.82a2fe3a.js";import"./modulepreload-polyfill.c7c6310f.js";import"./randomColor.7bbb2fda.js";function C(e){var a;const t=e.room,s=e.displayer,n=s.observerId,o=(a=s.state.roomMembers.find(d=>d.memberId===n))==null?void 0:a.payload,p=(t==null?void 0:t.uid)||(o==null?void 0:o.uid)||"",i=(o==null?void 0:o.nickName)||p;return{memberId:n,uid:p,nickName:i}}function D(e){const t=e.indexOf("?",1);return t!==-1?{search:e.slice(t),pathname:e.slice(0,t)}:{search:"",pathname:e}}function O(e,t){const{pathname:s,search:n}=D(e);return s+(n?`${n}&`:"?")+t}function f(e){return document.createElement(e)}function b(e,t,s){s==null?e.removeAttribute(t):e.setAttribute(t,s)}function g(e,t){return e.appendChild(t)}function _(e){var t;return(t=e.parentNode)==null?void 0:t.removeChild(e)}const y=Promise.resolve();function m(e){const t=[];return{get value(){return e},set(s){e=s,t.forEach(n=>n(e))},subscribe(s){return t.push(s),y.then(()=>s(e)),()=>{t.splice(t.indexOf(s),1)}}}}const P=`.app-talkative-container{width:100%;height:100%;overflow:hidden;display:flex;justify-content:center;align-items:center;flex-direction:column}.app-talkative-container iframe{width:100%;height:100%;border:none;display:block}.app-talkative-footer{display:flex;align-items:center;justify-content:center;gap:4px;box-sizing:border-box;background-color:#fff9;height:26px;padding:0 16px;border-top:1px solid #eeeef7;color:#191919}.telebox-color-scheme-dark .app-talkative-footer{color:#a6a6a8;background:#2d2d33;border-top:none}.app-talkative-page{font-variant-numeric:tabular-nums}.app-talkative-btn{box-sizing:border-box;width:26px;height:26px;font-size:14px;font-family:monospace;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;-webkit-tap-highlight-color:rgba(0,0,0,0);cursor:pointer;user-select:none;-webkit-user-select:none}.app-talkative-btn:hover{background:rgba(237,237,240,.9)}.telebox-color-scheme-dark .app-talkative-btn:hover{background:#212126}.telebox-color-scheme-dark .app-talkative-container{color:#eee}.app-talkative-btn:disabled{opacity:0;cursor:default}
`,A=window.ResizeObserver||L;class z{constructor(t){c(this,"sideEffect",new $);c(this,"box",this.context.box);c(this,"role",m(2));c(this,"ratio",m(16/9));c(this,"$content",f("div"));c(this,"$iframe",f("iframe"));this.context=t,b(this.$content,"class","app-talkative-container"),g(this.$content,this.$iframe),this.$content.dataset.appKind="Talkative"}_on_update_role(t){this.$content.dataset.role=String(t),this.$content.classList.toggle("owner",t===0)}_on_update_ratio(t,s){const{width:n,height:o}=s?s.contentRect:this.$content.getBoundingClientRect();if(n/t>o){const p=o*t;this.$iframe.style.width=`${p}px`,this.$iframe.style.height=""}else if(n/t<o){const p=n/t;this.$iframe.style.width="",this.$iframe.style.height=`${p}px`}}_observe_content_resize(){const t=new A(s=>{this._on_update_ratio(this.ratio.value,s[0])});return t.observe(this.$content),t.disconnect.bind(t)}mount(){return this.box.mountStyles(P),this.box.mountContent(this.$content),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.ratio.subscribe(this._on_update_ratio.bind(this))),this.sideEffect.addDisposer(this._observe_content_resize()),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),_(this.$content)}postMessage(t){var s;(s=this.$iframe.contentWindow)==null||s.postMessage(t,"*")}}class W{constructor(t,s,n){c(this,"sideEffect",new $);c(this,"box",this.context.box);c(this,"role",m(2));c(this,"text",m("..."));c(this,"$footer",f("div"));c(this,"$btnLeft",f("button"));c(this,"$btnRight",f("button"));c(this,"$span",f("span"));this.context=t,this.onPrev=s,this.onNext=n,g(this.$footer,this.$btnLeft),g(this.$footer,this.$span),g(this.$footer,this.$btnRight),b(this.$footer,"class","app-talkative-footer"),b(this.$btnLeft,"class","app-talkative-btn app-talkative-btn-left"),b(this.$btnRight,"class","app-talkative-btn app-talkative-btn-right"),b(this.$span,"class","app-talkative-page"),this.$btnLeft.textContent="<",this.$btnRight.textContent=">",this.$btnLeft.addEventListener("click",this.onPrev),this.$btnRight.addEventListener("click",this.onNext)}_on_update_role(t){this.$btnLeft.disabled=t===2,this.$btnRight.disabled=t===2,this.$footer.classList.toggle("owner",t===0)}_on_update_text(t){this.$span.textContent=t}mount(){return this.box.mountFooter(this.$footer),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.text.subscribe(this._on_update_text.bind(this))),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),_(this.$footer)}}function J({context:e,storage:t,logger:s,...n}){const o=new $,p={onPagenum({totalPages:i}){e.isWritable&&i&&t.setState({pageNum:i})},onLoadComplete(i){n.onRatioChanged(i.coursewareRatio),e.isWritable&&i.totalPages&&t.setState({pageNum:i.totalPages});const{page:a,lastMsg:d}=t.state;d&&n.postMessage(d),n.postMessage(JSON.stringify({method:"onJumpPage",toPage:a}))},onFileMessage(i){if(e.isWritable){e.dispatchMagixEvent("broadcast",JSON.stringify(i));const a=JSON.stringify({...i,isRestore:!0});t.setState({lastMsg:a})}}};return o.addDisposer(e.addMagixEventListener("broadcast",({payload:i})=>{n.postMessage(i)})),o.addEventListener(window,"message",i=>{if(!!n.isSentBySelf(i.source))if(typeof i.data=="string")try{const a=JSON.parse(i.data);if(typeof a=="object"&&a!==null){const d=p[a.method];d?d(a):s.warn("unknown message",a)}}catch(a){s.warn("error when parsing message",a)}else typeof i.data=="object"&&i.data!==null&&s.log("unhandled permission command",i.data)}),o.flushAll.bind(o)}const H={kind:"Talkative",setup(e){const t=e.attributes,s=e.createStorage("talkative",{src:"https://example.org",uid:"",page:1,pageNum:1,lastMsg:"",...t}),n=(e.getAppOptions()||{}).debug,o=new M("Talkative",n),{uid:p,memberId:i,nickName:a}=C(e),d=new $;o.log("my uid",p);const w=()=>{const{page:r}=s.state;e.isWritable&&r>1&&s.setState({page:r-1})},E=()=>{const{page:r,pageNum:l}=s.state;e.isWritable&&r<l&&s.setState({page:r+1})},h=new z(e),u=new W(e,w,E),k=h.postMessage.bind(h);d.addDisposer(J({context:e,storage:s,logger:o,postMessage:k,onRatioChanged:h.ratio.set.bind(h.ratio),isSentBySelf:r=>r===h.$iframe.contentWindow})),d.addDisposer(s.on("stateChanged",()=>{const r=s.state.uid===p?0:2;h.role.set(r),u.role.set(r);const{page:l,pageNum:v}=s.state;k(JSON.stringify({method:"onJumpPage",toPage:l})),u.text.set(`${l}/${v}`)}));const x=()=>{d.addDisposer(h.mount()),d.addDisposer(u.mount());const r=s.state.uid===p?0:2,l=`userid=${i}&role=${r}&name=${a}`;h.$iframe.src=O(s.state.src,l),h.role.set(r),u.role.set(r);const{page:v,pageNum:N}=s.state;u.text.set(`${v}/${N}`)};if(s.state.uid)y.then(x);else{const r=d.addDisposer(s.on("stateChanged",()=>{s.state.uid&&(d.flush(r),x())}));e.isAddApp&&(o.log("no teacher's uid, setting myself..."),s.setState({uid:p}))}e.emitter.on("destroy",()=>{o.log("destroy"),d.flushAll()})}};export{H as default};
