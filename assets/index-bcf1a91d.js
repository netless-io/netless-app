var z=Object.defineProperty;var L=(o,e,t)=>e in o?z(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var r=(o,e,t)=>(L(o,typeof e!="symbol"?e+"":e,t),t);import{V as $,L as M,o as E,R,p as x,q as v,w as V,_ as I,u as _}from"./index-13a0c33f.js";import"./modulepreload-polyfill-ec808ebb.js";const B=`.netless-app-docs-viewer-footer{box-sizing:border-box;height:26px;display:flex;align-items:center;padding:0 16px;border-top:1px solid #eeeef7;font-family:PingFang SC,Source Han Sans SC,Microsoft YaHei,Helvetica Neue,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif}.netless-app-docs-viewer-footer-btn{box-sizing:border-box;width:26px;height:26px;font-size:0;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;cursor:pointer;user-select:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}.netless-app-docs-viewer-footer-btn:hover{background:rgba(237,237,240,.9)}@media (hover: none){.netless-app-docs-viewer-footer-btn:hover{background:transparent!important}}.netless-app-docs-viewer-footer-btn>svg{width:100%;height:100%}.netless-app-docs-viewer-footer-btn>svg:nth-of-type(2){display:none}.netless-app-docs-viewer-footer-btn.netless-app-docs-viewer-footer-btn-playing>svg:nth-of-type(1){display:none}.netless-app-docs-viewer-footer-btn.netless-app-docs-viewer-footer-btn-playing>svg:nth-of-type(2){display:initial}.netless-app-docs-viewer-footer-btn~.netless-app-docs-viewer-footer-btn{margin-left:15px}.netless-app-docs-viewer-page-jumps{flex:1;display:flex;justify-content:center;align-items:center}.netless-app-docs-viewer-page-number{display:flex;align-items:center;height:26px;margin-left:auto;font-size:13px;white-space:nowrap;word-break:keep-all;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-docs-viewer-page-number-input{border:none;outline:none;width:3em;margin:0;padding:0 .5em 0 2px;text-align:right;font-size:13px;line-height:1;font-weight:400;font-family:inherit;border-radius:2px;color:currentColor;font-family:PingFang SC,Source Han Sans SC,Microsoft YaHei,Helvetica Neue,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif;background:transparent;transition:background .4s;-webkit-tap-highlight-color:rgba(0,0,0,0)}.netless-app-docs-viewer-page-number-input:hover,.netless-app-docs-viewer-page-number-input:focus,.netless-app-docs-viewer-page-number-input:active{user-select:text;background:#fff;box-shadow:#63636333 0 2px 8px}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-footer-btn{cursor:not-allowed}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-footer-btn:hover{background:transparent}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input{cursor:not-allowed}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:hover,.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:focus,.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:active{background:transparent;box-shadow:none}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:disabled{color:inherit}.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:active,.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:focus,.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:hover{color:currentColor;background:#25282e}.telebox-color-scheme-dark .netless-app-docs-viewer-footer{border-top:none}.telebox-color-scheme-dark .netless-app-docs-viewer-footer-btn:hover{background:#212126}.netless-app-docs-viewer-preview-mask{position:absolute;z-index:10200;top:0;left:0;width:100%;height:100%}.netless-app-docs-viewer-preview{box-sizing:border-box;display:flex;flex-direction:column;align-items:center;position:absolute;z-index:10300;top:0;left:0;width:33%;max-width:200px;height:100%;padding-top:10px;transform:translate(-100%);background:rgba(237,237,240,.9);box-shadow:inset -1px 0 #0000001c;transition:transform .4s;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-docs-viewer-preview.netless-app-docs-viewer-preview-active{transform:translate(0)}.netless-app-docs-viewer-preview-page{position:relative;display:block;width:55%;margin-bottom:10px;font-size:0;color:transparent;outline:none;border:7px solid transparent;border-radius:4px;transition:border-color .3s;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-docs-viewer-preview-page:hover,.netless-app-docs-viewer-preview-page.netless-app-docs-viewer-preview-page-active{border-color:#444e601a}.netless-app-docs-viewer-preview-page>img{width:100%;height:auto;box-sizing:border-box;border:1px solid rgba(0,0,0,.5);border-radius:1px;background-color:#fff;box-shadow:0 2px 8px #0000004d}.netless-app-docs-viewer-preview-page-name{position:absolute;top:1px;left:-10px;transform:translate(-100%);text-align:right;font-size:12px;color:#5f5f5f;user-select:none}.telebox-color-scheme-dark .netless-app-docs-viewer-preview{background:rgba(50,50,50,.9)}.netless-app-docs-viewer-content{position:relative;height:100%;overflow:hidden}.netless-app-docs-viewer-static-scrollbar{box-sizing:border-box;position:absolute;top:0;right:0;z-index:2147483647;width:16px;min-height:30px;margin:0;padding:0 0 0 8px;border:none;outline:none;opacity:0;background:transparent;transition:opacity .4s 3s,transform .1s;user-select:none;touch-action:none}.netless-app-docs-viewer-static-scrollbar:after{content:"";display:block;width:8px;height:100%;border-radius:4px;background:rgba(68,78,96,.4);box-shadow:1px 1px 8px #ffffffb3;transition:background .4s}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrolling{opacity:1;transition:opacity .4s,transform .1s}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrollbar-dragging{opacity:1;transition:opacity .4s 3s!important}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrollbar-dragging:after{background:rgba(68,78,96,.6)}.netless-app-docs-viewer-static-scrollbar:hover:after,.netless-app-docs-viewer-static-scrollbar:focus:after{background:rgba(68,78,96,.5)}.netless-app-docs-viewer-static-scrollbar:active:after{background:rgba(68,78,96,.6)}.telebox-body-wrap:hover .netless-app-docs-viewer-static-scrollbar{opacity:1;transition:opacity .4s,transform .1s}.telebox-readonly .netless-app-docs-viewer-static-scrollbar{display:none}.page-renderer-pages-container{position:relative;width:100%;height:100%}.page-renderer-page{position:absolute;top:0;left:0;background-position:center;background-size:cover;background-repeat:no-repeat}.page-renderer-pages-container.is-hwa .page-renderer-page{will-change:transform}.page-renderer-page-img{display:block;width:100%;height:auto;user-select:none}.netless-app-docs-viewer-static-pages{overflow:hidden;position:relative;height:100%;user-select:none}.netless-app-docs-viewer-static-page{display:block;width:100%;height:auto;user-select:none}.netless-app-docs-viewer-dynamic-wb-view{position:absolute;top:0;left:0;width:100%;height:100%;z-index:100;overflow:hidden}.netless-app-docs-viewer-dynamic-wb-view .cursor-clicker .ppt-event-source{cursor:pointer}
`;class H{constructor({namespace:e,pages$:t,sideEffect:s,readonly$:i,events:a,wrapClassName:n,root:d,pagesIndex$:u}){r(this,"namespace");r(this,"pages$");r(this,"sideEffect");r(this,"readonly$");r(this,"events");r(this,"wrapClassName");r(this,"showPreview$",new $(!1));r(this,"$preview");r(this,"$previewMask");r(this,"previewLazyLoad");this.namespace=e,this.pages$=t,this.sideEffect=s,this.readonly$=i,this.events=a,this.wrapClassName=n,this.sideEffect.addDisposer(this.events.on("togglePreview",()=>{this.showPreview$.setValue(!this.showPreview$.value)})),this.sideEffect.addDisposer(this.showPreview$.subscribe(l=>{this.sideEffect.add(()=>{const h=this.renderPreview(),w=this.renderPreviewMask();if(l){d.appendChild(h),d.appendChild(w),h.scrollTop;const p=h.querySelector("."+this.wrapClassName(`preview-page-${u.value}`));return p&&h.scrollTo({top:p.offsetTop-16}),h.classList.toggle(this.wrapClassName("preview-active"),!0),this.previewLazyLoad=new M({container:this.$preview,elements_selector:"."+this.wrapClassName("preview-page>img")}),()=>{var c;return(c=this.previewLazyLoad)==null?void 0:c.destroy()}}else return h.classList.toggle(this.wrapClassName("preview-active"),!1),this.sideEffect.setTimeout(()=>{h.remove(),w.remove()},500,"preview-remove"),null},"preview-lazyload")}))}destroy(){var e,t;(e=this.$preview)==null||e.remove(),(t=this.$previewMask)==null||t.remove()}renderPreview(){if(this.$preview)return this.$preview;const e=document.createElement("div");return e.className=this.wrapClassName("preview")+" tele-fancy-scrollbar",this.$preview=e,this.sideEffect.addEventListener(e,"wheel",t=>t.stopPropagation(),{passive:!1}),this.sideEffect.addDisposer(this.pages$.subscribe(t=>{var s;this.sideEffect.add(()=>{const i=t.map((a,n)=>{const d=a.thumbnail??(a.src.startsWith("ppt")?void 0:a.src);if(!d)return;const u=String(n),l=document.createElement("a");l.className=this.wrapClassName("preview-page")+" "+this.wrapClassName(`preview-page-${n}`),l.setAttribute("href","#"),l.dataset.pageIndex=u;const h=document.createElement("span");h.className=this.wrapClassName("preview-page-name"),h.textContent=String(n+1),h.dataset.pageIndex=u;const w=document.createElement("img");return w.width=a.width,w.height=a.height,w.dataset.src=d,w.dataset.pageIndex=u,l.appendChild(w),l.appendChild(h),e.appendChild(l),l});return()=>i.forEach(a=>a==null?void 0:a.remove())},"render-preview-pages"),(s=this.previewLazyLoad)==null||s.update()})),this.sideEffect.addEventListener(e,"click",t=>{var i;if(this.readonly$.value)return;const s=(i=t.target.dataset)==null?void 0:i.pageIndex;s&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.events.emit("jumpPage",Number(s)),this.showPreview$.setValue(!1))}),e}renderPreviewMask(){if(this.$previewMask)return this.$previewMask;const e=document.createElement("div");return e.className=this.wrapClassName("preview-mask"),this.$previewMask=e,this.sideEffect.addEventListener(e,"click",t=>{this.readonly$.value||t.target===e&&this.showPreview$.setValue(!1)}),e}}function U(o){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${o}-footer-icon-sidebar`),t.setAttribute("viewBox","0 0 64 64");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M50 8H14c-3.309 0-6 2.691-6 6v36c0 3.309 2.691 6 6 6h36c3.309 0 6-2.691 6-6V14c0-3.309-2.691-6-6-6zM12 50V14c0-1.103.897-2 2-2h8v40h-8c-1.103 0-2-.897-2-2zm40 0c0 1.103-.897 2-2 2H26V12h24c1.103 0 2 .897 2 2z"),t.appendChild(s),t}function F(o){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${o}-footer-icon-arrow-left`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M177.81 249.959L337.473 90.295c2.722-2.865 2.651-7.378-.143-10.1-2.793-2.65-7.163-2.65-9.956 0l-164.75 164.75c-2.793 2.793-2.793 7.306 0 10.1l164.75 164.75c2.865 2.722 7.378 2.65 10.099-.143 2.651-2.794 2.651-7.163 0-9.957L177.809 249.959z"),t.appendChild(s),t}function Y(o){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${o}-footer-icon-arrow-right`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M322.19 250.041L162.527 409.705c-2.722 2.865-2.651 7.378.143 10.1 2.793 2.65 7.163 2.65 9.956 0l164.75-164.75c2.793-2.793 2.793-7.306 0-10.1l-164.75-164.75c-2.865-2.722-7.378-2.65-10.099.143-2.651 2.794-2.651 7.163 0 9.957l159.664 159.736z"),t.appendChild(s),t}function W(o){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${o}-footer-icon-play`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M418.158 257.419L174.663 413.33c-6.017 3.919-15.708 3.772-21.291-.29-2.791-2.018-4.295-4.483-4.295-7.084V94.109c0-5.65 6.883-10.289 15.271-10.289 4.298 0 8.391 1.307 11.181 3.332l242.629 155.484c6.016 3.917 6.451 10.292.649 14.491-.216.154-.432.154-.649.292zM170.621 391.288l223.116-141.301L170.71 107.753l-.089 283.535z"),t.appendChild(s),t}function j(o){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${o}-footer-icon-pause`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M312.491 78.261c0-6.159 4.893-11.213 11.04-11.213 6.158 0 11.211 5.054 11.211 11.213v343.478c0 6.159-5.053 11.213-11.211 11.213-6.147 0-11.04-5.054-11.04-11.213V78.261zM165.257 78.261c0-6.159 4.893-11.213 11.04-11.213 6.158 0 11.211 5.054 11.211 11.213v343.478c0 6.159-5.053 11.213-11.211 11.213-6.147 0-11.04-5.054-11.04-11.213V78.261z"),t.appendChild(s),t}function O(o){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${o}-footer-icon-save`),t.setAttribute("viewBox","0 0 448 512");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M224 256c-35.2 0-64 28.8-64 64c0 35.2 28.8 64 64 64c35.2 0 64-28.8 64-64C288 284.8 259.2 256 224 256zM433.1 129.1l-83.9-83.9C341.1 37.06 328.8 32 316.1 32H64C28.65 32 0 60.65 0 96v320c0 35.35 28.65 64 64 64h320c35.35 0 64-28.65 64-64V163.9C448 151.2 442.9 138.9 433.1 129.1zM128 80h144V160H128V80zM400 416c0 8.836-7.164 16-16 16H64c-8.836 0-16-7.164-16-16V96c0-8.838 7.164-16 16-16h16v104c0 13.25 10.75 24 24 24h192C309.3 208 320 197.3 320 184V83.88l78.25 78.25C399.4 163.2 400 164.8 400 166.3V416z"),t.appendChild(s),t}function G(o){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${o}-footer-icon-spinner`),t.setAttribute("viewBox","0 0 512 512");const s=document.createElementNS(e,"path");s.setAttribute("fill","currentColor"),s.setAttribute("d","M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z");const i=document.createElementNS(e,"animateTransform");i.setAttribute("attributeName","transform"),i.setAttribute("attributeType","xml"),i.setAttribute("type","rotate"),i.setAttribute("from","0 256 256"),i.setAttribute("to","360 256 256"),i.setAttribute("begin","0s"),i.setAttribute("dur","2s"),i.setAttribute("fill","freeze"),i.setAttribute("repeatCount","indefinite"),s.appendChild(i);const a=document.createElementNS(e,"text");return a.setAttribute("x","125"),a.setAttribute("y","345"),a.setAttribute("data-id","progress"),a.style.fontSize="246px",a.textContent="20",t.appendChild(a),t.appendChild(s),t}class q{constructor({namespace:e,pages$:t,sideEffect:s,readonly$:i,events:a,playable:n,wrapClassName:d,pagesIndex$:u,root:l}){r(this,"namespace");r(this,"pages$");r(this,"sideEffect");r(this,"readonly$");r(this,"events");r(this,"playable");r(this,"wrapClassName");r(this,"pagesIndex$");r(this,"$footer");this.namespace=e,this.pages$=t,this.sideEffect=s,this.readonly$=i,this.events=a,this.wrapClassName=d,this.pagesIndex$=u,this.playable=n,this.$footer=this.render(),l.appendChild(this.$footer)}destroy(){this.$footer.remove()}render(){const e=document.createElement("div");e.className=this.wrapClassName("footer"),this.sideEffect.addDisposer(this.readonly$.subscribe(p=>e.classList.toggle(this.wrapClassName("readonly"),p)));const t=this.renderFooterBtn("btn-sidebar",U(this.namespace));this.sideEffect.addEventListener(t,"click",()=>{this.readonly$.value||this.events.emit("togglePreview")}),e.appendChild(t),this.sideEffect.addDisposer(this.pages$.subscribe(p=>{const c=p.some(g=>g.thumbnail||!g.src.startsWith("ppt"));t.style.display=c?"":"none"}));const s=document.createElement("div");s.className=this.wrapClassName("page-jumps");const i=this.renderFooterBtn("btn-page-back",F(this.namespace));if(this.sideEffect.addEventListener(i,"click",()=>{this.readonly$.value||this.events.emit("back")}),s.appendChild(i),this.playable){const p=this.renderFooterBtn("btn-page-play",W(this.namespace),j(this.namespace));this.sideEffect.addEventListener(p,"click",()=>{this.readonly$.value||(p.classList.toggle(this.wrapClassName("footer-btn-playing"),!0),this.events.emit("play"),this.sideEffect.setTimeout(()=>p.classList.toggle(this.wrapClassName("footer-btn-playing"),!1),500,"returnPlay"))}),s.appendChild(p)}const a=this.renderFooterBtn("btn-page-next",Y(this.namespace));this.sideEffect.addEventListener(a,"click",()=>{this.readonly$.value||this.events.emit("next")}),s.appendChild(a);const n=document.createElement("div");n.className=this.wrapClassName("page-number");const d=document.createElement("input");d.className=this.wrapClassName("page-number-input"),this.sideEffect.addDisposer(this.readonly$.subscribe(p=>d.disabled=p)),this.sideEffect.addDisposer(this.pagesIndex$.subscribe(p=>d.value=String(p+1))),this.sideEffect.addEventListener(d,"blur",()=>{d.value=String(this.pagesIndex$.value+1)}),this.sideEffect.addEventListener(d,"change",()=>{if(this.readonly$.value)return;const p=d.value?Number(d.value)-1:NaN;p>=0?this.events.emit("jumpPage",p):d.value=String(this.pagesIndex$.value+1)});const u=document.createElement("span");this.sideEffect.addDisposer(this.pages$.subscribe(p=>{u.textContent=" / "+p.length})),n.appendChild(d),n.appendChild(u),e.appendChild(s),e.appendChild(n);const l=O(this.namespace),h=G(this.namespace);h.style.display="none";const w=document.createElement("button");return w.className=this.wrapClassName("footer-btn"),w.appendChild(l),w.appendChild(h),this.sideEffect.addEventListener(w,"click",()=>{this.events.emit("save")}),this.events.on("saveProgress",p=>{if(p<99){h.style.display="block",l.style.display="none";const c=h.querySelector("[data-id]");c&&(c.textContent=p.toString().padStart(2,"0"))}else h.style.display="none",l.style.display="block"}),e}renderFooterBtn(e,t,s){const i=document.createElement("button");return i.className=this.wrapClassName("footer-btn")+" "+this.wrapClassName(e),i.appendChild(t),s&&i.appendChild(s),i}}class P{constructor({readonly$:e,pagesIndex$:t,previewRoot:s,footerRoot:i,pages$:a,playable:n}){r(this,"preview");r(this,"footer");r(this,"wrapClassName",e=>`${this.namespace}-${e}`);r(this,"namespace","netless-app-docs-viewer");r(this,"sideEffect",new E);r(this,"events",new R);this.preview=new H({pages$:a,readonly$:e,pagesIndex$:t,root:s,sideEffect:this.sideEffect,events:this.events,namespace:this.namespace,wrapClassName:this.wrapClassName}),this.footer=new q({pages$:a,readonly$:e,playable:n,pagesIndex$:t,root:i,namespace:this.namespace,sideEffect:this.sideEffect,events:this.events,wrapClassName:this.wrapClassName})}destroy(){this.preview.destroy(),this.footer.destroy(),this.sideEffect.flushAll(),this.events.destroy()}}function S(o,e,t){return Math.min(Math.max(o,e),t)}function k(o){return o.touches?o.touches[0]:o}function T(o){o.stopPropagation(),o.cancelable&&o.preventDefault()}function A(o,e){return o.width===e.width&&o.height===e.height}class X{constructor(e){r(this,"stiffness");r(this,"damping");r(this,"current");r(this,"target");r(this,"velocity",0);r(this,"onStep");r(this,"_paused",!0);r(this,"_animationFrameID",null);r(this,"_loopTimestamp",0);r(this,"looper",e=>{var s;if(this._paused)return;let t=Math.floor((e-this._loopTimestamp)/1e3*60)+1;for(this._loopTimestamp=e;t-- >0;)this.stepper();(s=this.onStep)==null||s.call(this,this.current),this._paused?this._animationFrameID=null:this._animationFrameID=window.requestAnimationFrame(this.looper)});this.current=e.start??0,this.target=this.current,this.stiffness=e.stiffness??170,this.damping=e.damping??26,this.onStep=e.onStep}get paused(){return this._paused}stepTo(e,t){var s;this._paused&&t!=null&&(this.current=t),this._paused=!1,this.target=e,(s=this.onStep)==null||s.call(this,this.current),this._loopTimestamp=Date.now(),this._animationFrameID=window.requestAnimationFrame(this.looper)}pause(){this._paused=!0,this._animationFrameID!=null&&window.cancelAnimationFrame(this._animationFrameID)}destroy(){this.pause(),this.onStep=void 0}stepper(){const e=-this.stiffness*(this.current-this.target),t=-this.damping*this.velocity,s=this.velocity+(e+t)/60,i=this.current+s/60;Math.abs(s-0)<.01&&Math.abs(i-this.target)<.01?(this.current=this.target,this.velocity=0,this._paused=!0):(this.current=i,this.velocity=s)}}class J{constructor(e,t,s,i,a,n){r(this,"lastVisit",Date.now());r(this,"$page");r(this,"sideEffect",new E);this.index=e;const d=x(t,p=>p[e]||{width:0,height:0}),u=v([d,s],([p,c])=>(c.width-p.width)/2),l=v([a,n],([p,c])=>(p[e]||0)-c),h=document.createElement("div");h.className="page-renderer-page",h.dataset.index=`${e}`;const w=document.createElement("img");w.className="page-renderer-page-img",h.appendChild(w),this.sideEffect.addDisposer([v([d,i]).subscribe(([p,c])=>{h.style.width=`${p.width*c}px`,h.style.height=`${p.height*c}px`}),d.subscribe(p=>{p.thumbnail&&(h.style.backgroundImage=`url("${p.thumbnail}")`),w.width=p.width,w.height=p.height,w.src=p.src}),v([u,l,i]).subscribe(([p,c,g])=>{h.style.transform=`translate(${p*g}px, ${c*g}px)`})]),this.$page=h}destroy(){this.sideEffect.flushAll(),this.$page.remove()}}class K{constructor(e,t,s,i,a){r(this,"els",new Map);r(this,"maxElCount",200);r(this,"gcTimer",null);r(this,"schedule");r(this,"cancelSchedule");r(this,"gc",()=>{var e;if(this.gcTimer=null,this.els.size>this.maxElCount){const t=[...this.els.values()].sort((s,i)=>i.lastVisit-s.lastVisit);for(let s=Math.floor(this.maxElCount/4);s<t.length;s++)(e=this.els.get(t[s].index))==null||e.destroy(),this.els.delete(t[s].index)}});this.pages$=e,this.pagesSize$=t,this.scale$=s,this.pagesYs$=i,this.pagesScrollTop$=a,this.schedule=window.requestIdleCallback||(n=>window.setTimeout(n,5e3)),this.cancelSchedule=window.cancelIdleCallback||window.clearTimeout}getEl(e){let t=this.els.get(e);return t||(t=new J(e,this.pages$,this.pagesSize$,this.scale$,this.pagesYs$,this.pagesScrollTop$),this.els.set(e,t)),t.lastVisit=Date.now(),this.els.size>this.maxElCount&&this.gcTimer===null&&(this.gcTimer=this.schedule(this.gc)),t}destroy(){this.els.forEach(e=>e.destroy()),this.els.clear(),this.gcTimer!==null&&(this.cancelSchedule(this.gcTimer),this.gcTimer=null)}}class Q{constructor({pagesScrollTop$:e,containerRect$:t,pages$:s,pagesSize$:i}){r(this,"$pages");r(this,"sideEffect",new E);r(this,"pageElManager");s=x(s,c=>c.map(g=>{if(g.thumbnail)return g;try{const m=new URL(g.src);return m.searchParams.set("x-oss-process","image/resize,l_50"),{...g,thumbnail:m.toString()}}catch(m){return console.error(m),g}}));const a=x(s,c=>{const g=Array(c.length);for(let m=0;m<c.length;m++)g[m]=m>0?g[m-1]+c[m-1].height:0;return g}),n=x(s,c=>{let g=1/0;for(let m=c.length-1;m>=0;m--)c[m].height<=g&&(g=c[m].height);return g}),d=v([e,a,s],([c,g,m])=>{if(g.length!==m.length)return d.value;for(let f=0;f<g.length;f++)if(g[f]+m[f].height-c>=.001)return f;return g.length-1}),u=v([t,i],([c,g])=>c.width/g.width||1),l=v([s,t,n,u],([c,g,m,f])=>S(Math.ceil(g.height/f/m/2),1,c.length));V(this,{pagesScrollTop:e,containerRect:t,pages:s,pagesSize:i,pagesIndex:d,pagesYs:a,pagesMinHeight:n,scale:u}),this.pageElManager=new K(s,i,u,a,e),this.$pages=this.renderPages();const h=new $(!1);this.sideEffect.addDisposer(h.subscribe(c=>this.$pages.classList.toggle("is-hwa",c)));const w=()=>h.setValue(!1),p=()=>{this.sideEffect.setTimeout(w,1e3,"turn-off-hwa"),h.setValue(!0)};this.sideEffect.addDisposer(v([d,l,s]).subscribe(([c,g,m])=>{p();const f=Math.max(c-g,0),C=Math.min(c+g,m.length-1);for(let b=0;b<this.$pages.children.length;b++){const y=this.$pages.children[b],N=Number(y.dataset.index);N>=f&&N<=C||(y.remove(),b--)}for(let b=f;b<=C;b++){const y=this.pageElManager.getEl(b);y.$page.parentElement!==this.$pages&&this.$pages.appendChild(y.$page)}}))}renderPages(){const e=document.createElement("div");return e.className="page-renderer-pages-container",this.sideEffect.addDisposer(this._containerRect$.subscribe(t=>{e.style.width=`${t.width}px`,e.style.height=`${t.height}px`}),"render-pages-size"),e}destroy(){this.sideEffect.flushAll(),this.$pages.remove(),this.pageElManager.destroy()}}const Z=30;class ee{constructor({pagesScrollTop$:e,containerRect$:t,stageRect$:s,pagesSize$:i,readonly$:a,scrollbarMinHeight:n=Z,wrapClassName:d,onDragScroll:u}){r(this,"sideEffect",new E);r(this,"scrollbarMinHeight");r(this,"readonly$");r(this,"wrapClassName");r(this,"onDragScroll");r(this,"$scrollbar");r(this,"pagesScrollTop$");r(this,"containerRect$");r(this,"stageRect$");r(this,"pagesSize$");r(this,"scrolling$",new $(!1));r(this,"scrollbarHeight$");r(this,"scrollTop$");this.pagesScrollTop$=e,this.containerRect$=t,this.stageRect$=s,this.pagesSize$=i,this.scrollbarMinHeight=n,this.readonly$=a,this.wrapClassName=d,this.onDragScroll=u,this.scrollbarHeight$=v([t,s,i],([l,h,w])=>S(h.height/(h.width/w.width*w.height)*l.height,n,l.height)),this.scrollTop$=v([t,s,i,this.scrollbarHeight$,this.pagesScrollTop$],([l,h,w,p,c])=>S(c/(w.height-w.width/h.width*h.height)*(l.height-p),0,l.height-p)),this.$scrollbar=this.renderScrollbar()}mount(e){e.appendChild(this.$scrollbar)}destroy(){this.$scrollbar.remove(),this.onDragScroll=void 0,this.sideEffect.flushAll()}renderScrollbar(){const e=document.createElement("button");e.className=this.wrapClassName("scrollbar"),e.style.minHeight=`${this.scrollbarMinHeight}px`,this.sideEffect.addDisposer([this.scrollbarHeight$.subscribe(s=>{e.style.height=`${s}px`}),this.scrollTop$.subscribe(s=>{this.scrolling$.setValue(!0),this.sideEffect.setTimeout(()=>this.scrolling$.setValue(!1),100,"reset-scrolling");const i=()=>e.style.transform=`translateY(${s}px)`;window.requestAnimationFrame?window.requestAnimationFrame(i):i()}),this.scrolling$.subscribe(s=>{e.classList.toggle(this.wrapClassName("scrolling"),s)})]);const t=s=>{if(!s.isPrimary||this.readonly$.value||s.button!=null&&s.button!==0)return;T(s);const i=this.wrapClassName("scrollbar-dragging");e.classList.toggle(i,!0);const a=this.pagesScrollTop$.value,{clientY:n}=k(s),d=l=>{if(!l.isPrimary||this.readonly$.value)return;const{clientY:h}=k(l),w=h-n;Math.abs(w)>0&&this.onDragScroll&&this.onDragScroll(a+w/this.containerRect$.value.height*this.pagesSize$.value.height)},u=l=>{l.isPrimary&&(e.classList.toggle(i,!1),window.removeEventListener("pointermove",d,!0),window.removeEventListener("pointerup",u,!0),window.removeEventListener("pointercancel",u,!0))};window.addEventListener("pointermove",d,!0),window.addEventListener("pointerup",u,!0),window.addEventListener("pointercancel",u,!0)};return this.sideEffect.addEventListener(e,"pointerdown",t),e}}class te{constructor({whiteboard:e,readonly$:t,box:s,pages:i,pagesScrollTop:a=0,onUserScroll:n}){r(this,"readonly$");r(this,"pagesScrollTop$");r(this,"pagesSize$");r(this,"pageRenderer");r(this,"scrollbar");r(this,"sideEffect",new E);r(this,"pageScrollStepper");r(this,"userScrolling",!1);r(this,"pages");r(this,"box");r(this,"whiteboard");r(this,"onUserScroll");r(this,"debounceOnUserScroll");r(this,"viewer");r(this,"toPdf",async()=>{const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return null;const s=this.whiteboard.pageState.pages[0],i=this.pages[0],{jsPDF:a}=await I(()=>import("./jspdf.es.min-e0b4708e.js"),["./jspdf.es.min-e0b4708e.js","./index-13a0c33f.js","./modulepreload-polyfill-ec808ebb.js","./index-7e97d6a9.css"],import.meta.url),n=new a({format:[i.width,i.height],orientation:i.width>i.height?"l":"p",compress:!0});for(const[w,p]of this.pages.entries()){const{width:c,height:g,src:m}=p;e.width=c,e.height=g;const f=c>g?"l":"p";w>0&&n.addPage([c,g],f);const C=await this.getBase64FromUrl(m),b=document.createElement("img");b.src=C,await new Promise(D=>b.onload=D),t.drawImage(b,0,0);const y=e.toDataURL("image/jpeg",.6);t.clearRect(0,0,c,g),this.whiteboard.view.screenshotToCanvas(t,s,c,g,{centerX:c/2,centerY:g/2+w*g,scale:1});const N=e.toDataURL("image/png");n.addImage(y,"JPEG",0,0,c,g,"","FAST"),n.addImage(N,"PNG",0,0,c,g,"","FAST"),t.clearRect(0,0,c,g),this.viewer.events.emit("saveProgress",Math.ceil((w+1)/this.pages.length*100))}const d=n.output("arraybuffer"),u=new Blob([d]),l=URL.createObjectURL(u),h=document.createElement("a");h.setAttribute("href",l),h.setAttribute("download",`${this.box.title}.pdf`),h.style.display="none",document.body.appendChild(h),h.click(),document.body.removeChild(h),window.postMessage({type:"@app-slide/_download_pdf_",buf:d})});this.whiteboard=e,this.readonly$=t,this.box=s,this.pages=i,this.onUserScroll=n;const d=()=>{var l;this.userScrolling=!1,(l=this.onUserScroll)==null||l.call(this,this.pagesScrollTop$.value)};this.debounceOnUserScroll=()=>{this.userScrolling=!0,this.sideEffect.setTimeout(d,80,"debounceOnUserScroll")};const u=new $(i);this.pagesScrollTop$=new $(a),this.pagesSize$=x(u,l=>{let h=0,w=0;for(let p=l.length-1;p>=0;p--){const c=l[p];c.width>h&&(h=c.width),w+=c.height}return{width:Math.max(1,h),height:Math.max(1,w)}},{compare:A}),this.pageRenderer=new Q({pagesScrollTop$:this.pagesScrollTop$,containerRect$:s._stageRect$,pages$:u,pagesSize$:this.pagesSize$}),this.viewer=new P({readonly$:t,pagesIndex$:this.pageRenderer._pagesIndex$,previewRoot:s.$body,footerRoot:s.$footer,pages$:u,playable:!1}),this.sideEffect.addDisposer([this.viewer.events.on("next",()=>{this.userScrollByPercent(.8)}),this.viewer.events.on("back",()=>{this.userScrollByPercent(-.8)})]),this.scrollbar=new ee({pagesScrollTop$:this.pagesScrollTop$,containerRect$:s._bodyRect$,stageRect$:s._stageRect$,pagesSize$:this.pagesSize$,readonly$:t,wrapClassName:this.wrapClassName.bind(this),onDragScroll:l=>{this.pageScrollTo(l),this.debounceOnUserScroll()}}),this.pageScrollStepper=new X({start:this.pagesScrollTop$.value,onStep:l=>{this.pageScrollTo(l)}}),this.sideEffect.addDisposer(this.viewer.events.on("jumpPage",l=>this.userScrollToPageIndex(l))),this.sideEffect.addDisposer(this.viewer.events.on("save",()=>this.toPdf())),this.render(),this.setupScrollListener(),this.sideEffect.setTimeout(()=>{this.userScrolling||this.pageScrollTo(this.pageRenderer.pagesScrollTop)},100)}get pagesScrollTop(){return this.pagesScrollTop$.value}destroy(){this.sideEffect.flushAll(),this.pageScrollStepper.destroy(),this.onUserScroll=void 0,this.viewer.destroy(),this.pageRenderer.destroy(),this.scrollbar.destroy()}syncPageScrollTop(e){!this.userScrolling&&e>=0&&Math.abs(this.pagesScrollTop$.value-e)>.01&&this.pageScrollStepper.stepTo(e,this.pagesScrollTop$.value)}async getBase64FromUrl(e){const s=await(await fetch(e)).blob();return new Promise(i=>{const a=new FileReader;a.readAsDataURL(s),a.onloadend=()=>{const n=a.result;i(n)}})}render(){this.box.$content.style.overflow="hidden",this.box.mountStage(this.pageRenderer.$pages),this.scrollbar.mount(this.box.$body)}pageScrollTo(e){const t=this.whiteboard.view.size.height/2/this.pageRenderer.scale;this.whiteboard.view.moveCamera({centerY:S(e+t,t,this.pagesSize$.value.height-t),animationMode:"immediately"})}userScrollToPageIndex(e){var t;if(e=S(e,0,this.pages.length-1),!this.readonly$.value&&!Number.isNaN(e)){const s=this.pageRenderer.pagesYs[e];s>=0&&((t=this.onUserScroll)==null||t.call(this,s+5/this.pageRenderer.scale))}}userScrollByPercent(e){var t;this.readonly$.value||(t=this.onUserScroll)==null||t.call(this,S(this.pageRenderer.pagesScrollTop+this.pageRenderer.containerRect.height/this.pageRenderer.scale*S(e,-1,1),0,this.pageRenderer.pagesSize.height-this.pageRenderer.containerRect.height/this.pageRenderer.scale))}setupScrollListener(){this.sideEffect.addEventListener(this.box.$main,"wheel",t=>{T(t),!this.readonly$.value&&this.pageScrollStepper.paused&&(this.pageScrollTo(this.pagesScrollTop+t.deltaY),this.debounceOnUserScroll())},{passive:!1}),this.sideEffect.addEventListener(this.box.$main,"touchmove",t=>{!this.readonly$.value&&t.touches.length>1&&this.debounceOnUserScroll()},{passive:!0,capture:!0}),this.sideEffect.add(()=>{const t=s=>{const{width:i,height:a}=this.whiteboard.view.size;if(i<=0||a<=0)return;const n=s.centerY-this.pageRenderer.containerRect.height/this.pageRenderer.scale/2;this.pagesScrollTop$.setValue(Math.max(0,n))};return this.whiteboard.view.callbacks.on("onCameraUpdated",t),()=>this.whiteboard.view.callbacks.off("onCameraUpdated",t)}),this.sideEffect.addDisposer(this.box._stageRect$.subscribe(t=>{const{width:s,height:i}=this.pagesSize$.value;this.whiteboard.view.moveCameraToContain({originX:0,originY:this.pageRenderer.pagesScrollTop,width:s,height:t.height/this.pageRenderer.scale,animationMode:"immediately"}),this.whiteboard.view.setCameraBound({damping:1,maxContentMode:()=>this.pageRenderer.scale,minContentMode:()=>this.pageRenderer.scale,centerX:s/2,centerY:i/2,width:s,height:i})}),"whiteboard-size-update");const e=t=>{if(!t)return!1;const s=t.tagName;return s==="INPUT"||s==="TEXTAREA"||s==="SELECT"};this.sideEffect.addEventListener(window,"keyup",t=>{if(!(this.readonly$.value||!this.box.focus||this.box.minimized||e(t.target)))switch(t.key){case"PageDown":{this.userScrollByPercent(.8);break}case"PageUp":{this.userScrollByPercent(-.8);break}case"ArrowLeft":{this.userScrollByPercent(-.25);break}case"ArrowRight":{this.userScrollByPercent(.25);break}case"ArrowDown":{this.userScrollByPercent(.5);break}case"ArrowUp":{this.userScrollByPercent(-.5);break}}},{capture:!0})}wrapClassName(e){return"netless-app-docs-viewer-static-"+e}}class se{constructor({readonly$:e,context:t,whiteboard:s,box:i,pages:a}){r(this,"pagesIndex$");r(this,"sideEffect",new E);r(this,"context");r(this,"pages");r(this,"box");r(this,"whiteboard");r(this,"viewer");this.context=t,this.whiteboard=s,this.box=i,this.pages=a;const n=new $(t.displayer.state.sceneState.index||0);this.pagesIndex$=n,this.sideEffect.add(()=>{const d=u=>{this.jumpToPage(u.index)};return this.context.emitter.on("sceneStateChange",d),()=>this.context.emitter.off("sceneStateChange",d)}),this.viewer=new P({readonly$:e,pagesIndex$:n,previewRoot:i.$body,footerRoot:i.$footer,pages$:new $(a),playable:!0}),this.sideEffect.addDisposer([this.viewer.events.on("jumpPage",d=>this.jumpToPage(d,!0)),this.viewer.events.on("play",()=>{var d;return(d=this.context.room)==null?void 0:d.pptNextStep()}),this.viewer.events.on("back",()=>this.prevPage()),this.viewer.events.on("next",()=>this.nextPage())]),this.render(),this.sideEffect.addDisposer(n.subscribe((d,u)=>{var w,p;if(e.value)return;const l=this.context.getInitScenePath(),h=(p=(w=this.context.getScenes())==null?void 0:w[d])==null?void 0:p.name;if(l&&h&&this.context.setScenePath(`${l}/${h}`),u){const c=this.context.room;if(c){const g=c.state.globalState.__pptState;c.setGlobalState({__pptState:g&&{uuid:g.uuid,pageIndex:d,disableAutoPlay:g.disableAutoPlay}})}}}))}destroy(){this.sideEffect.flushAll(),this.viewer.destroy()}nextPage(){this.jumpToPage(this.pagesIndex$.value+1,!0)}prevPage(){this.jumpToPage(this.pagesIndex$.value-1,!0)}jumpToPage(e,t=!1){this.pagesIndex$.setValue(S(e,0,this.pages.length-1),t)}render(){var t;this.box.mountStage(document.createElement("div")),this.sideEffect.addEventListener(window,"keydown",s=>{var i;if(this.box.focus)switch(s.key){case"ArrowUp":case"ArrowLeft":{this.prevPage();break}case"ArrowRight":case"ArrowDown":{(i=this.context.room)==null||i.pptNextStep();break}}});const e=(t=this.whiteboard.view.divElement)==null?void 0:t.parentElement;e&&this.sideEffect.addEventListener(e,"click",s=>{var a;const i=this.context.room;if(i&&i.state.memberState.currentApplianceName==="clicker"){for(let n=s.target;n;n=n.parentElement)if((a=n.classList)!=null&&a.contains("ppt-event-source"))return;i.pptNextStep()}})}wrapClassName(e){return"netless-app-docs-viewer-dynamic-"+e}}const le={kind:_,setup(o){const e=o.box,t=o.getScenes();if(!t)throw new Error("[Docs Viewer]: scenes not found.");const s=new E,i=t.map(({ppt:n})=>n?{width:n.width,height:n.height,src:n.src,thumbnail:n.previewURL}:null).filter(n=>Boolean(n));if(i.length<=0)throw new Error("[Docs Viewer]: empty scenes.");e.mountStyles(B);const a=new $(!o.isWritable);s.addDisposer(o.emitter.on("writableChange",n=>{a.setValue(!n)})),i[0].src.startsWith("ppt")?re(s,o,e,i,a):ie(s,o,e,i,a),s.addDisposer(o.emitter.on("destroy",()=>{s.flushAll()}))}};function ie(o,e,t,s,i){const a=e.createWhiteBoardView({syncCamera:!1});o.addDisposer(i.subscribe(u=>{a.view.disableCameraTransform=u}));const n=e.createStorage("static-docs-viewer",{pagesScrollTop:0}),d=new te({whiteboard:a,readonly$:i,box:t,pages:s,pagesScrollTop:n.state.pagesScrollTop,onUserScroll:u=>{e.isWritable&&n.setState({pagesScrollTop:u})}});o.addDisposer(()=>d.destroy()),o.addDisposer(n.on("stateChanged",u=>{u.pagesScrollTop&&d.syncPageScrollTop(u.pagesScrollTop.newValue||0)})),o.addDisposer(v([t._maximized$,t._managerStageRect$,t._intrinsicSize$,d.pagesSize$,d.pageRenderer._pagesMinHeight$],([u,l,h,w,p])=>u?Math.max(p/w.width*(2/5),l.height/l.width):h.height/h.width*(l.height/l.width)).subscribe(u=>{t.setStageRatio(u)}))}function re(o,e,t,s,i){const a=e.createWhiteBoardView();a.view.disableCameraTransform=!0;const n=new se({context:e,whiteboard:a,box:t,pages:s,readonly$:i});o.addDisposer(()=>n.destroy());const d=new $({width:s[0].width,height:s[0].height},{compare:A});if(o.addDisposer(n.pagesIndex$.subscribe(u=>{const l=s[u];l&&d.setValue({width:l.width,height:l.height})})),o.addDisposer(d.subscribe(u=>{i.value||a.setBaseRect(u)})),e.isAddApp){const u=o.add(()=>{const l=({width:h,height:w})=>{if(s.length>0&&t.state!=="maximized"){const{width:p,height:c}=s[0],m=c/p*h-w;m!==0&&e.isWritable&&e.emitter.emit("setBoxSize",{width:t.intrinsicWidth,height:t.intrinsicHeight+m/t.rootRect.height})}o.remove(u)};return a.view.callbacks.once("onSizeUpdated",l),()=>a.view.callbacks.off("onSizeUpdated",l)})}}export{P as DocsViewer,le as NetlessAppDocsViewer,Q as PageRenderer,ee as ScrollBar,X as Stepper,le as default};
