var L=Object.defineProperty;var z=(n,e,t)=>e in n?L(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var i=(n,e,t)=>(z(n,typeof e!="symbol"?e+"":e,t),t);import{V as b,L as M,o as y,R as A,p as E,q as m,w as R,u as V}from"./index.e441a2dd.js";import"./modulepreload-polyfill.c7c6310f.js";const I=`.netless-app-docs-viewer-footer{box-sizing:border-box;height:26px;display:flex;align-items:center;padding:0 16px;border-top:1px solid #eeeef7;font-family:PingFang SC,Source Han Sans SC,Microsoft YaHei,Helvetica Neue,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif}.netless-app-docs-viewer-footer-btn{box-sizing:border-box;width:26px;height:26px;font-size:0;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;cursor:pointer;user-select:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}.netless-app-docs-viewer-footer-btn:hover{background:rgba(237,237,240,.9)}@media (hover: none){.netless-app-docs-viewer-footer-btn:hover{background:transparent!important}}.netless-app-docs-viewer-footer-btn>svg{width:100%;height:100%}.netless-app-docs-viewer-footer-btn>svg:nth-of-type(2){display:none}.netless-app-docs-viewer-footer-btn.netless-app-docs-viewer-footer-btn-playing>svg:nth-of-type(1){display:none}.netless-app-docs-viewer-footer-btn.netless-app-docs-viewer-footer-btn-playing>svg:nth-of-type(2){display:initial}.netless-app-docs-viewer-footer-btn~.netless-app-docs-viewer-footer-btn{margin-left:15px}.netless-app-docs-viewer-page-jumps{flex:1;display:flex;justify-content:center;align-items:center}.netless-app-docs-viewer-page-number{display:flex;align-items:center;height:26px;margin-left:auto;font-size:13px;white-space:nowrap;word-break:keep-all;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-docs-viewer-page-number-input{border:none;outline:none;width:3em;margin:0;padding:0 .5em 0 2px;text-align:right;font-size:13px;line-height:1;font-weight:400;font-family:inherit;border-radius:2px;color:currentColor;font-family:PingFang SC,Source Han Sans SC,Microsoft YaHei,Helvetica Neue,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif;background:transparent;transition:background .4s;-webkit-tap-highlight-color:rgba(0,0,0,0)}.netless-app-docs-viewer-page-number-input:hover,.netless-app-docs-viewer-page-number-input:focus,.netless-app-docs-viewer-page-number-input:active{user-select:text;background:#fff;box-shadow:#63636333 0 2px 8px}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-footer-btn{cursor:not-allowed}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-footer-btn:hover{background:transparent}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input{cursor:not-allowed}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:hover,.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:focus,.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:active{background:transparent;box-shadow:none}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:disabled{color:inherit}.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:active,.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:focus,.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:hover{color:currentColor;background:#25282e}.telebox-color-scheme-dark .netless-app-docs-viewer-footer{border-top:none}.telebox-color-scheme-dark .netless-app-docs-viewer-footer-btn:hover{background:#212126}.netless-app-docs-viewer-preview-mask{position:absolute;z-index:10200;top:0;left:0;width:100%;height:100%}.netless-app-docs-viewer-preview{box-sizing:border-box;display:flex;flex-direction:column;align-items:center;position:absolute;z-index:10300;top:0;left:0;width:33%;max-width:200px;height:100%;padding-top:10px;transform:translate(-100%);background:rgba(237,237,240,.9);box-shadow:inset -1px 0 #0000001c;transition:transform .4s;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-docs-viewer-preview.netless-app-docs-viewer-preview-active{transform:translate(0)}.netless-app-docs-viewer-preview-page{position:relative;display:block;width:55%;margin-bottom:10px;font-size:0;color:transparent;outline:none;border:7px solid transparent;border-radius:4px;transition:border-color .3s;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-docs-viewer-preview-page:hover,.netless-app-docs-viewer-preview-page.netless-app-docs-viewer-preview-page-active{border-color:#444e601a}.netless-app-docs-viewer-preview-page>img{width:100%;height:auto;box-sizing:border-box;border:1px solid rgba(0,0,0,.5);border-radius:1px;background-color:#fff;box-shadow:0 2px 8px #0000004d}.netless-app-docs-viewer-preview-page-name{position:absolute;top:1px;left:-10px;transform:translate(-100%);text-align:right;font-size:12px;color:#5f5f5f;user-select:none}.telebox-color-scheme-dark .netless-app-docs-viewer-preview{background:rgba(50,50,50,.9)}.netless-app-docs-viewer-content{position:relative;height:100%;overflow:hidden}.netless-app-docs-viewer-static-scrollbar{box-sizing:border-box;position:absolute;top:0;right:0;z-index:2147483647;width:16px;min-height:30px;margin:0;padding:0 0 0 8px;border:none;outline:none;opacity:0;background:transparent;transition:opacity .4s 3s,transform .1s;user-select:none;touch-action:none}.netless-app-docs-viewer-static-scrollbar:after{content:"";display:block;width:8px;height:100%;border-radius:4px;background:rgba(68,78,96,.4);box-shadow:1px 1px 8px #ffffffb3;transition:background .4s}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrolling{opacity:1;transition:opacity .4s,transform .1s}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrollbar-dragging{opacity:1;transition:opacity .4s 3s!important}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrollbar-dragging:after{background:rgba(68,78,96,.6)}.netless-app-docs-viewer-static-scrollbar:hover:after,.netless-app-docs-viewer-static-scrollbar:focus:after{background:rgba(68,78,96,.5)}.netless-app-docs-viewer-static-scrollbar:active:after{background:rgba(68,78,96,.6)}.telebox-body-wrap:hover .netless-app-docs-viewer-static-scrollbar{opacity:1;transition:opacity .4s,transform .1s}.telebox-readonly .netless-app-docs-viewer-static-scrollbar{display:none}.page-renderer-pages-container{position:relative;width:100%;height:100%}.page-renderer-page{position:absolute;top:0;left:0;background-position:center;background-size:cover;background-repeat:no-repeat}.page-renderer-pages-container.is-hwa .page-renderer-page{will-change:transform}.page-renderer-page-img{display:block;width:100%;height:auto;user-select:none}.netless-app-docs-viewer-static-pages{overflow:hidden;position:relative;height:100%;user-select:none}.netless-app-docs-viewer-static-page{display:block;width:100%;height:auto;user-select:none}.netless-app-docs-viewer-dynamic-wb-view{position:absolute;top:0;left:0;width:100%;height:100%;z-index:100;overflow:hidden}.netless-app-docs-viewer-dynamic-wb-view .cursor-clicker .ppt-event-source{cursor:pointer}
`;class _{constructor({namespace:e,pages$:t,sideEffect:s,readonly$:r,events:o,wrapClassName:l,root:c,pagesIndex$:h}){i(this,"namespace");i(this,"pages$");i(this,"sideEffect");i(this,"readonly$");i(this,"events");i(this,"wrapClassName");i(this,"showPreview$",new b(!1));i(this,"$preview");i(this,"$previewMask");i(this,"previewLazyLoad");this.namespace=e,this.pages$=t,this.sideEffect=s,this.readonly$=r,this.events=o,this.wrapClassName=l,this.sideEffect.addDisposer(this.events.on("togglePreview",()=>{this.showPreview$.setValue(!this.showPreview$.value)})),this.sideEffect.addDisposer(this.showPreview$.subscribe(a=>{this.sideEffect.add(()=>{const p=this.renderPreview(),g=this.renderPreviewMask();if(a){c.appendChild(p),c.appendChild(g),p.scrollTop;const u=p.querySelector("."+this.wrapClassName(`preview-page-${h.value}`));return u&&p.scrollTo({top:u.offsetTop-16}),p.classList.toggle(this.wrapClassName("preview-active"),!0),this.previewLazyLoad=new M({container:this.$preview,elements_selector:"."+this.wrapClassName("preview-page>img")}),()=>{var d;return(d=this.previewLazyLoad)==null?void 0:d.destroy()}}else return p.classList.toggle(this.wrapClassName("preview-active"),!1),this.sideEffect.setTimeout(()=>{p.remove(),g.remove()},500,"preview-remove"),null},"preview-lazyload")}))}destroy(){var e,t;(e=this.$preview)==null||e.remove(),(t=this.$previewMask)==null||t.remove()}renderPreview(){if(this.$preview)return this.$preview;const e=document.createElement("div");return e.className=this.wrapClassName("preview")+" tele-fancy-scrollbar",this.$preview=e,this.sideEffect.addEventListener(e,"wheel",t=>t.stopPropagation(),{passive:!1}),this.sideEffect.addDisposer(this.pages$.subscribe(t=>{var s;this.sideEffect.add(()=>{const r=t.map((o,l)=>{var u;const c=(u=o.thumbnail)!=null?u:o.src.startsWith("ppt")?void 0:o.src;if(!c)return;const h=String(l),a=document.createElement("a");a.className=this.wrapClassName("preview-page")+" "+this.wrapClassName(`preview-page-${l}`),a.setAttribute("href","#"),a.dataset.pageIndex=h;const p=document.createElement("span");p.className=this.wrapClassName("preview-page-name"),p.textContent=String(l+1),p.dataset.pageIndex=h;const g=document.createElement("img");return g.width=o.width,g.height=o.height,g.dataset.src=c,g.dataset.pageIndex=h,a.appendChild(g),a.appendChild(p),e.appendChild(a),a});return()=>r.forEach(o=>o==null?void 0:o.remove())},"render-preview-pages"),(s=this.previewLazyLoad)==null||s.update()})),this.sideEffect.addEventListener(e,"click",t=>{var r;if(this.readonly$.value)return;const s=(r=t.target.dataset)==null?void 0:r.pageIndex;s&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.events.emit("jumpPage",Number(s)),this.showPreview$.setValue(!1))}),e}renderPreviewMask(){if(this.$previewMask)return this.$previewMask;const e=document.createElement("div");return e.className=this.wrapClassName("preview-mask"),this.$previewMask=e,this.sideEffect.addEventListener(e,"click",t=>{this.readonly$.value||t.target===e&&this.showPreview$.setValue(!1)}),e}}function H(n){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${n}-footer-icon-sidebar`),t.setAttribute("viewBox","0 0 64 64");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M50 8H14c-3.309 0-6 2.691-6 6v36c0 3.309 2.691 6 6 6h36c3.309 0 6-2.691 6-6V14c0-3.309-2.691-6-6-6zM12 50V14c0-1.103.897-2 2-2h8v40h-8c-1.103 0-2-.897-2-2zm40 0c0 1.103-.897 2-2 2H26V12h24c1.103 0 2 .897 2 2z"),t.appendChild(s),t}function B(n){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${n}-footer-icon-arrow-left`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M177.81 249.959L337.473 90.295c2.722-2.865 2.651-7.378-.143-10.1-2.793-2.65-7.163-2.65-9.956 0l-164.75 164.75c-2.793 2.793-2.793 7.306 0 10.1l164.75 164.75c2.865 2.722 7.378 2.65 10.099-.143 2.651-2.794 2.651-7.163 0-9.957L177.809 249.959z"),t.appendChild(s),t}function U(n){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${n}-footer-icon-arrow-right`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M322.19 250.041L162.527 409.705c-2.722 2.865-2.651 7.378.143 10.1 2.793 2.65 7.163 2.65 9.956 0l164.75-164.75c2.793-2.793 2.793-7.306 0-10.1l-164.75-164.75c-2.865-2.722-7.378-2.65-10.099.143-2.651 2.794-2.651 7.163 0 9.957l159.664 159.736z"),t.appendChild(s),t}function F(n){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${n}-footer-icon-play`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M418.158 257.419L174.663 413.33c-6.017 3.919-15.708 3.772-21.291-.29-2.791-2.018-4.295-4.483-4.295-7.084V94.109c0-5.65 6.883-10.289 15.271-10.289 4.298 0 8.391 1.307 11.181 3.332l242.629 155.484c6.016 3.917 6.451 10.292.649 14.491-.216.154-.432.154-.649.292zM170.621 391.288l223.116-141.301L170.71 107.753l-.089 283.535z"),t.appendChild(s),t}function W(n){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${n}-footer-icon-pause`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M312.491 78.261c0-6.159 4.893-11.213 11.04-11.213 6.158 0 11.211 5.054 11.211 11.213v343.478c0 6.159-5.053 11.213-11.211 11.213-6.147 0-11.04-5.054-11.04-11.213V78.261zM165.257 78.261c0-6.159 4.893-11.213 11.04-11.213 6.158 0 11.211 5.054 11.211 11.213v343.478c0 6.159-5.053 11.213-11.211 11.213-6.147 0-11.04-5.054-11.04-11.213V78.261z"),t.appendChild(s),t}class Y{constructor({namespace:e,pages$:t,sideEffect:s,readonly$:r,events:o,playable:l,wrapClassName:c,pagesIndex$:h,root:a}){i(this,"namespace");i(this,"pages$");i(this,"sideEffect");i(this,"readonly$");i(this,"events");i(this,"playable");i(this,"wrapClassName");i(this,"pagesIndex$");i(this,"$footer");this.namespace=e,this.pages$=t,this.sideEffect=s,this.readonly$=r,this.events=o,this.wrapClassName=c,this.pagesIndex$=h,this.playable=l,this.$footer=this.render(),a.appendChild(this.$footer)}destroy(){this.$footer.remove()}render(){const e=document.createElement("div");e.className=this.wrapClassName("footer"),this.sideEffect.addDisposer(this.readonly$.subscribe(a=>e.classList.toggle(this.wrapClassName("readonly"),a)));const t=this.renderFooterBtn("btn-sidebar",H(this.namespace));this.sideEffect.addEventListener(t,"click",()=>{this.readonly$.value||this.events.emit("togglePreview")}),e.appendChild(t),this.sideEffect.addDisposer(this.pages$.subscribe(a=>{const p=a.some(g=>g.thumbnail||!g.src.startsWith("ppt"));t.style.display=p?"":"none"}));const s=document.createElement("div");s.className=this.wrapClassName("page-jumps");const r=this.renderFooterBtn("btn-page-back",B(this.namespace));if(this.sideEffect.addEventListener(r,"click",()=>{this.readonly$.value||this.events.emit("back")}),s.appendChild(r),this.playable){const a=this.renderFooterBtn("btn-page-play",F(this.namespace),W(this.namespace));this.sideEffect.addEventListener(a,"click",()=>{this.readonly$.value||(a.classList.toggle(this.wrapClassName("footer-btn-playing"),!0),this.events.emit("play"),this.sideEffect.setTimeout(()=>a.classList.toggle(this.wrapClassName("footer-btn-playing"),!1),500,"returnPlay"))}),s.appendChild(a)}const o=this.renderFooterBtn("btn-page-next",U(this.namespace));this.sideEffect.addEventListener(o,"click",()=>{this.readonly$.value||this.events.emit("next")}),s.appendChild(o);const l=document.createElement("div");l.className=this.wrapClassName("page-number");const c=document.createElement("input");c.className=this.wrapClassName("page-number-input"),this.sideEffect.addDisposer(this.readonly$.subscribe(a=>c.disabled=a)),this.sideEffect.addDisposer(this.pagesIndex$.subscribe(a=>c.value=String(a+1))),this.sideEffect.addEventListener(c,"blur",()=>{c.value=String(this.pagesIndex$.value+1)}),this.sideEffect.addEventListener(c,"change",()=>{if(this.readonly$.value)return;const a=c.value?Number(c.value)-1:NaN;a>=0?this.events.emit("jumpPage",a):c.value=String(this.pagesIndex$.value+1)});const h=document.createElement("span");return this.sideEffect.addDisposer(this.pages$.subscribe(a=>{h.textContent=" / "+a.length})),l.appendChild(c),l.appendChild(h),e.appendChild(s),e.appendChild(l),e}renderFooterBtn(e,t,s){const r=document.createElement("button");return r.className=this.wrapClassName("footer-btn")+" "+this.wrapClassName(e),r.appendChild(t),s&&r.appendChild(s),r}}class T{constructor({readonly$:e,pagesIndex$:t,previewRoot:s,footerRoot:r,pages$:o,playable:l}){i(this,"preview");i(this,"footer");i(this,"wrapClassName",e=>`${this.namespace}-${e}`);i(this,"namespace","netless-app-docs-viewer");i(this,"sideEffect",new y);i(this,"events",new A);this.preview=new _({pages$:o,readonly$:e,pagesIndex$:t,root:s,sideEffect:this.sideEffect,events:this.events,namespace:this.namespace,wrapClassName:this.wrapClassName}),this.footer=new Y({pages$:o,readonly$:e,playable:l,pagesIndex$:t,root:r,namespace:this.namespace,sideEffect:this.sideEffect,events:this.events,wrapClassName:this.wrapClassName})}destroy(){this.preview.destroy(),this.footer.destroy(),this.sideEffect.flushAll(),this.events.destroy()}}function S(n,e,t){return Math.min(Math.max(n,e),t)}function N(n){return n.touches?n.touches[0]:n}function P(n){n.stopPropagation(),n.cancelable&&n.preventDefault()}function D(n,e){return n.width===e.width&&n.height===e.height}class O{constructor(e){i(this,"stiffness");i(this,"damping");i(this,"current");i(this,"target");i(this,"velocity",0);i(this,"onStep");i(this,"_paused",!0);i(this,"_animationFrameID",null);i(this,"_loopTimestamp",0);i(this,"looper",e=>{var s;if(this._paused)return;let t=Math.floor((e-this._loopTimestamp)/1e3*60)+1;for(this._loopTimestamp=e;t-- >0;)this.stepper();(s=this.onStep)==null||s.call(this,this.current),this._paused?this._animationFrameID=null:this._animationFrameID=window.requestAnimationFrame(this.looper)});var t,s,r;this.current=(t=e.start)!=null?t:0,this.target=this.current,this.stiffness=(s=e.stiffness)!=null?s:170,this.damping=(r=e.damping)!=null?r:26,this.onStep=e.onStep}get paused(){return this._paused}stepTo(e,t){var s;this._paused&&t!=null&&(this.current=t),this._paused=!1,this.target=e,(s=this.onStep)==null||s.call(this,this.current),this._loopTimestamp=Date.now(),this._animationFrameID=window.requestAnimationFrame(this.looper)}pause(){this._paused=!0,this._animationFrameID!=null&&window.cancelAnimationFrame(this._animationFrameID)}destroy(){this.pause(),this.onStep=void 0}stepper(){const e=-this.stiffness*(this.current-this.target),t=-this.damping*this.velocity,s=this.velocity+(e+t)/60,r=this.current+s/60;Math.abs(s-0)<.01&&Math.abs(r-this.target)<.01?(this.current=this.target,this.velocity=0,this._paused=!0):(this.current=r,this.velocity=s)}}class j{constructor(e,t,s,r,o,l){i(this,"lastVisit",Date.now());i(this,"$page");i(this,"sideEffect",new y);this.index=e;const c=E(t,u=>u[e]||{width:0,height:0}),h=m([c,s],([u,d])=>(d.width-u.width)/2),a=m([o,l],([u,d])=>(u[e]||0)-d),p=document.createElement("div");p.className="page-renderer-page",p.dataset.index=`${e}`;const g=document.createElement("img");g.className="page-renderer-page-img",p.appendChild(g),this.sideEffect.addDisposer([m([c,r]).subscribe(([u,d])=>{p.style.width=`${u.width*d}px`,p.style.height=`${u.height*d}px`}),c.subscribe(u=>{u.thumbnail&&(p.style.backgroundImage=`url("${u.thumbnail}")`),g.width=u.width,g.height=u.height,g.src=u.src}),m([h,a,r]).subscribe(([u,d,w])=>{p.style.transform=`translate(${u*w}px, ${d*w}px)`})]),this.$page=p}destroy(){this.sideEffect.flushAll(),this.$page.remove()}}class q{constructor(e,t,s,r,o){i(this,"els",new Map);i(this,"maxElCount",200);i(this,"gcTimer",null);i(this,"schedule");i(this,"cancelSchedule");i(this,"gc",()=>{var e;if(this.gcTimer=null,this.els.size>this.maxElCount){const t=[...this.els.values()].sort((s,r)=>r.lastVisit-s.lastVisit);for(let s=Math.floor(this.maxElCount/4);s<t.length;s++)(e=this.els.get(t[s].index))==null||e.destroy(),this.els.delete(t[s].index)}});this.pages$=e,this.pagesSize$=t,this.scale$=s,this.pagesYs$=r,this.pagesScrollTop$=o,this.schedule=window.requestIdleCallback||(l=>window.setTimeout(l,5e3)),this.cancelSchedule=window.cancelIdleCallback||window.clearTimeout}getEl(e){let t=this.els.get(e);return t||(t=new j(e,this.pages$,this.pagesSize$,this.scale$,this.pagesYs$,this.pagesScrollTop$),this.els.set(e,t)),t.lastVisit=Date.now(),this.els.size>this.maxElCount&&this.gcTimer===null&&(this.gcTimer=this.schedule(this.gc)),t}destroy(){this.els.forEach(e=>e.destroy()),this.els.clear(),this.gcTimer!==null&&(this.cancelSchedule(this.gcTimer),this.gcTimer=null)}}class G{constructor({pagesScrollTop$:e,containerRect$:t,pages$:s,pagesSize$:r}){i(this,"$pages");i(this,"sideEffect",new y);i(this,"pageElManager");s=E(s,d=>d.map(w=>{if(w.thumbnail)return w;try{const f=new URL(w.src);return f.searchParams.set("x-oss-process","image/resize,l_50"),{...w,thumbnail:f.toString()}}catch(f){return console.error(f),w}}));const o=E(s,d=>{const w=Array(d.length);for(let f=0;f<d.length;f++)w[f]=f>0?w[f-1]+d[f-1].height:0;return w}),l=E(s,d=>{let w=1/0;for(let f=d.length-1;f>=0;f--)d[f].height<=w&&(w=d[f].height);return w}),c=m([e,o,s],([d,w,f])=>{if(w.length!==f.length)return c.value;for(let v=0;v<w.length;v++)if(w[v]+f[v].height-d>=.001)return v;return w.length-1}),h=m([t,r],([d,w])=>d.width/w.width||1),a=m([s,t,l,h],([d,w,f,v])=>S(Math.ceil(w.height/v/f/2),1,d.length));R(this,{pagesScrollTop:e,containerRect:t,pages:s,pagesSize:r,pagesIndex:c,pagesYs:o,pagesMinHeight:l,scale:h}),this.pageElManager=new q(s,r,h,o,e),this.$pages=this.renderPages();const p=new b(!1);this.sideEffect.addDisposer(p.subscribe(d=>this.$pages.classList.toggle("is-hwa",d)));const g=()=>p.setValue(!1),u=()=>{this.sideEffect.setTimeout(g,1e3,"turn-off-hwa"),p.setValue(!0)};this.sideEffect.addDisposer(m([c,a,s]).subscribe(([d,w,f])=>{u();const v=Math.max(d-w,0),C=Math.min(d+w,f.length-1);for(let $=0;$<this.$pages.children.length;$++){const x=this.$pages.children[$],k=Number(x.dataset.index);k>=v&&k<=C||(x.remove(),$--)}for(let $=v;$<=C;$++){const x=this.pageElManager.getEl($);x.$page.parentElement!==this.$pages&&this.$pages.appendChild(x.$page)}}))}renderPages(){const e=document.createElement("div");return e.className="page-renderer-pages-container",this.sideEffect.addDisposer(this._containerRect$.subscribe(t=>{e.style.width=`${t.width}px`,e.style.height=`${t.height}px`}),"render-pages-size"),e}destroy(){this.sideEffect.flushAll(),this.$pages.remove(),this.pageElManager.destroy()}}const J=30;class X{constructor({pagesScrollTop$:e,containerRect$:t,stageRect$:s,pagesSize$:r,readonly$:o,scrollbarMinHeight:l=J,wrapClassName:c,onDragScroll:h}){i(this,"sideEffect",new y);i(this,"scrollbarMinHeight");i(this,"readonly$");i(this,"wrapClassName");i(this,"onDragScroll");i(this,"$scrollbar");i(this,"pagesScrollTop$");i(this,"containerRect$");i(this,"stageRect$");i(this,"pagesSize$");i(this,"scrolling$",new b(!1));i(this,"scrollbarHeight$");i(this,"scrollTop$");this.pagesScrollTop$=e,this.containerRect$=t,this.stageRect$=s,this.pagesSize$=r,this.scrollbarMinHeight=l,this.readonly$=o,this.wrapClassName=c,this.onDragScroll=h,this.scrollbarHeight$=m([t,s,r],([a,p,g])=>S(p.height/(p.width/g.width*g.height)*a.height,l,a.height)),this.scrollTop$=m([t,s,r,this.scrollbarHeight$,this.pagesScrollTop$],([a,p,g,u,d])=>S(d/(g.height-g.width/p.width*p.height)*(a.height-u),0,a.height-u)),this.$scrollbar=this.renderScrollbar()}mount(e){e.appendChild(this.$scrollbar)}destroy(){this.$scrollbar.remove(),this.onDragScroll=void 0,this.sideEffect.flushAll()}renderScrollbar(){const e=document.createElement("button");e.className=this.wrapClassName("scrollbar"),e.style.minHeight=`${this.scrollbarMinHeight}px`,this.sideEffect.addDisposer([this.scrollbarHeight$.subscribe(s=>{e.style.height=`${s}px`}),this.scrollTop$.subscribe(s=>{this.scrolling$.setValue(!0),this.sideEffect.setTimeout(()=>this.scrolling$.setValue(!1),100,"reset-scrolling");const r=()=>e.style.transform=`translateY(${s}px)`;window.requestAnimationFrame?window.requestAnimationFrame(r):r()}),this.scrolling$.subscribe(s=>{e.classList.toggle(this.wrapClassName("scrolling"),s)})]);const t=s=>{if(!s.isPrimary||this.readonly$.value||s.button!=null&&s.button!==0)return;P(s);const r=this.wrapClassName("scrollbar-dragging");e.classList.toggle(r,!0);const o=this.pagesScrollTop$.value,{clientY:l}=N(s),c=a=>{if(!a.isPrimary||this.readonly$.value)return;const{clientY:p}=N(a),g=p-l;Math.abs(g)>0&&this.onDragScroll&&this.onDragScroll(o+g/this.containerRect$.value.height*this.pagesSize$.value.height)},h=a=>{!a.isPrimary||(e.classList.toggle(r,!1),window.removeEventListener("pointermove",c,!0),window.removeEventListener("pointerup",h,!0),window.removeEventListener("pointercancel",h,!0))};window.addEventListener("pointermove",c,!0),window.addEventListener("pointerup",h,!0),window.addEventListener("pointercancel",h,!0)};return this.sideEffect.addEventListener(e,"pointerdown",t),e}}class K{constructor({whiteboard:e,readonly$:t,box:s,pages:r,pagesScrollTop:o=0,onUserScroll:l}){i(this,"readonly$");i(this,"pagesScrollTop$");i(this,"pagesSize$");i(this,"pageRenderer");i(this,"scrollbar");i(this,"sideEffect",new y);i(this,"pageScrollStepper");i(this,"userScrolling",!1);i(this,"pages");i(this,"box");i(this,"whiteboard");i(this,"onUserScroll");i(this,"debounceOnUserScroll");i(this,"viewer");this.whiteboard=e,this.readonly$=t,this.box=s,this.pages=r,this.onUserScroll=l;const c=()=>{var a;this.userScrolling=!1,(a=this.onUserScroll)==null||a.call(this,this.pagesScrollTop$.value)};this.debounceOnUserScroll=()=>{this.userScrolling=!0,this.sideEffect.setTimeout(c,80,"debounceOnUserScroll")};const h=new b(r);this.pagesScrollTop$=new b(o),this.pagesSize$=E(h,a=>{let p=0,g=0;for(let u=a.length-1;u>=0;u--){const d=a[u];d.width>p&&(p=d.width),g+=d.height}return{width:Math.max(1,p),height:Math.max(1,g)}},{compare:D}),this.pageRenderer=new G({pagesScrollTop$:this.pagesScrollTop$,containerRect$:s._stageRect$,pages$:h,pagesSize$:this.pagesSize$}),this.viewer=new T({readonly$:t,pagesIndex$:this.pageRenderer._pagesIndex$,previewRoot:s.$body,footerRoot:s.$footer,pages$:h,playable:!1}),this.sideEffect.addDisposer([this.viewer.events.on("next",()=>{this.userScrollByPercent(.8)}),this.viewer.events.on("back",()=>{this.userScrollByPercent(-.8)})]),this.scrollbar=new X({pagesScrollTop$:this.pagesScrollTop$,containerRect$:s._bodyRect$,stageRect$:s._stageRect$,pagesSize$:this.pagesSize$,readonly$:t,wrapClassName:this.wrapClassName.bind(this),onDragScroll:a=>{this.pageScrollTo(a),this.debounceOnUserScroll()}}),this.pageScrollStepper=new O({start:this.pagesScrollTop$.value,onStep:a=>{this.pageScrollTo(a)}}),this.sideEffect.addDisposer(this.viewer.events.on("jumpPage",a=>this.userScrollToPageIndex(a))),this.render(),this.setupScrollListener(),this.sideEffect.setTimeout(()=>{this.userScrolling||this.pageScrollTo(this.pageRenderer.pagesScrollTop)},100)}get pagesScrollTop(){return this.pagesScrollTop$.value}destroy(){this.sideEffect.flushAll(),this.pageScrollStepper.destroy(),this.onUserScroll=void 0,this.viewer.destroy(),this.pageRenderer.destroy(),this.scrollbar.destroy()}syncPageScrollTop(e){!this.userScrolling&&e>=0&&Math.abs(this.pagesScrollTop$.value-e)>.01&&this.pageScrollStepper.stepTo(e,this.pagesScrollTop$.value)}render(){this.box.$content.style.overflow="hidden",this.box.mountStage(this.pageRenderer.$pages),this.scrollbar.mount(this.box.$body)}pageScrollTo(e){const t=this.whiteboard.view.size.height/2/this.pageRenderer.scale;this.whiteboard.view.moveCamera({centerY:S(e+t,t,this.pagesSize$.value.height-t),animationMode:"immediately"})}userScrollToPageIndex(e){var t;if(e=S(e,0,this.pages.length-1),!this.readonly$.value&&!Number.isNaN(e)){const s=this.pageRenderer.pagesYs[e];s>=0&&((t=this.onUserScroll)==null||t.call(this,s+5/this.pageRenderer.scale))}}userScrollByPercent(e){var t;this.readonly$.value||(t=this.onUserScroll)==null||t.call(this,S(this.pageRenderer.pagesScrollTop+this.pageRenderer.containerRect.height/this.pageRenderer.scale*S(e,-1,1),0,this.pageRenderer.pagesSize.height-this.pageRenderer.containerRect.height/this.pageRenderer.scale))}setupScrollListener(){this.sideEffect.addEventListener(this.box.$main,"wheel",e=>{P(e),!this.readonly$.value&&this.pageScrollStepper.paused&&(this.pageScrollTo(this.pagesScrollTop+e.deltaY),this.debounceOnUserScroll())},{passive:!1}),this.sideEffect.addEventListener(this.box.$main,"touchmove",e=>{!this.readonly$.value&&e.touches.length>1&&this.debounceOnUserScroll()},{passive:!0,capture:!0}),this.sideEffect.add(()=>{const e=t=>{const{width:s,height:r}=this.whiteboard.view.size;if(s<=0||r<=0)return;const o=t.centerY-this.pageRenderer.containerRect.height/this.pageRenderer.scale/2;this.pagesScrollTop$.setValue(Math.max(0,o))};return this.whiteboard.view.callbacks.on("onCameraUpdated",e),()=>this.whiteboard.view.callbacks.off("onCameraUpdated",e)}),this.sideEffect.addDisposer(this.box._stageRect$.subscribe(e=>{const{width:t,height:s}=this.pagesSize$.value;this.whiteboard.view.moveCameraToContain({originX:0,originY:this.pageRenderer.pagesScrollTop,width:t,height:e.height/this.pageRenderer.scale,animationMode:"immediately"}),this.whiteboard.view.setCameraBound({damping:1,maxContentMode:()=>this.pageRenderer.scale,minContentMode:()=>this.pageRenderer.scale,centerX:t/2,centerY:s/2,width:t,height:s})}),"whiteboard-size-update"),this.sideEffect.addEventListener(window,"keyup",e=>{if(!(this.readonly$.value||!this.box.focus||this.box.minimized))switch(e.key){case"PageDown":{this.userScrollByPercent(.8);break}case"PageUp":{this.userScrollByPercent(-.8);break}case"ArrowLeft":{this.userScrollByPercent(-.25);break}case"ArrowRight":{this.userScrollByPercent(.25);break}case"ArrowDown":{this.userScrollByPercent(.5);break}case"ArrowUp":{this.userScrollByPercent(-.5);break}}},{capture:!0})}wrapClassName(e){return"netless-app-docs-viewer-static-"+e}}class Q{constructor({readonly$:e,context:t,whiteboard:s,box:r,pages:o}){i(this,"pagesIndex$");i(this,"sideEffect",new y);i(this,"context");i(this,"pages");i(this,"box");i(this,"whiteboard");i(this,"viewer");this.context=t,this.whiteboard=s,this.box=r,this.pages=o;const l=new b(t.displayer.state.sceneState.index||0);this.pagesIndex$=l,this.sideEffect.add(()=>{const c=h=>{this.jumpToPage(h.index)};return this.context.emitter.on("sceneStateChange",c),()=>this.context.emitter.off("sceneStateChange",c)}),this.viewer=new T({readonly$:e,pagesIndex$:l,previewRoot:r.$body,footerRoot:r.$footer,pages$:new b(o),playable:!0}),this.sideEffect.addDisposer([this.viewer.events.on("jumpPage",c=>this.jumpToPage(c,!0)),this.viewer.events.on("play",()=>{var c;return(c=this.context.room)==null?void 0:c.pptNextStep()}),this.viewer.events.on("back",()=>this.prevPage()),this.viewer.events.on("next",()=>this.nextPage())]),this.render(),this.sideEffect.addDisposer(l.subscribe((c,h)=>{var g,u;if(e.value)return;const a=this.context.getInitScenePath(),p=(u=(g=this.context.getScenes())==null?void 0:g[c])==null?void 0:u.name;if(a&&p&&this.context.setScenePath(`${a}/${p}`),h){const d=this.context.room;if(d){const w=d.state.globalState.__pptState;d.setGlobalState({__pptState:w&&{uuid:w.uuid,pageIndex:c,disableAutoPlay:w.disableAutoPlay}})}}}))}destroy(){this.sideEffect.flushAll(),this.viewer.destroy()}nextPage(){this.jumpToPage(this.pagesIndex$.value+1,!0)}prevPage(){this.jumpToPage(this.pagesIndex$.value-1,!0)}jumpToPage(e,t=!1){this.pagesIndex$.setValue(S(e,0,this.pages.length-1),t)}render(){var t;this.box.mountStage(document.createElement("div")),this.sideEffect.addEventListener(window,"keydown",s=>{var r;if(this.box.focus)switch(s.key){case"ArrowUp":case"ArrowLeft":{this.prevPage();break}case"ArrowRight":case"ArrowDown":{(r=this.context.room)==null||r.pptNextStep();break}}});const e=(t=this.whiteboard.view.divElement)==null?void 0:t.parentElement;e&&this.sideEffect.addEventListener(e,"click",s=>{var o;const r=this.context.room;if(r&&r.state.memberState.currentApplianceName==="clicker"){for(let l=s.target;l;l=l.parentElement)if((o=l.classList)!=null&&o.contains("ppt-event-source"))return;r.pptNextStep()}})}wrapClassName(e){return"netless-app-docs-viewer-dynamic-"+e}}const re={kind:V,setup(n){const e=n.box,t=n.getScenes();if(!t)throw new Error("[Docs Viewer]: scenes not found.");const s=new y,r=t.map(({ppt:l})=>l?{width:l.width,height:l.height,src:l.src,thumbnail:l.previewURL}:null).filter(l=>Boolean(l));if(r.length<=0)throw new Error("[Docs Viewer]: empty scenes.");e.mountStyles(I);const o=new b(!n.isWritable);s.addDisposer(n.emitter.on("writableChange",l=>{o.setValue(!l)})),r[0].src.startsWith("ppt")?ee(s,n,e,r,o):Z(s,n,e,r,o),s.addDisposer(n.emitter.on("destroy",()=>{s.flushAll()}))}};function Z(n,e,t,s,r){const o=e.createWhiteBoardView({syncCamera:!1});n.addDisposer(r.subscribe(h=>{o.view.disableCameraTransform=h}));const l=e.createStorage("static-docs-viewer",{pagesScrollTop:0}),c=new K({whiteboard:o,readonly$:r,box:t,pages:s,pagesScrollTop:l.state.pagesScrollTop,onUserScroll:h=>{e.isWritable&&l.setState({pagesScrollTop:h})}});n.addDisposer(()=>c.destroy()),n.addDisposer(l.on("stateChanged",h=>{h.pagesScrollTop&&c.syncPageScrollTop(h.pagesScrollTop.newValue||0)})),n.addDisposer(m([t._maximized$,t._managerStageRect$,t._intrinsicSize$,c.pagesSize$,c.pageRenderer._pagesMinHeight$],([h,a,p,g,u])=>h?Math.max(u/g.width*(2/5),a.height/a.width):p.height/p.width*(a.height/a.width)).subscribe(h=>{t.setStageRatio(h)}))}function ee(n,e,t,s,r){const o=e.createWhiteBoardView();o.view.disableCameraTransform=!0;const l=new Q({context:e,whiteboard:o,box:t,pages:s,readonly$:r});n.addDisposer(()=>l.destroy());const c=new b({width:s[0].width,height:s[0].height},{compare:D});if(n.addDisposer(l.pagesIndex$.subscribe(h=>{const a=s[h];a&&c.setValue({width:a.width,height:a.height})})),n.addDisposer(c.subscribe(h=>{r.value||o.setBaseRect(h)})),e.isAddApp){const h=n.add(()=>{const a=({width:p,height:g})=>{if(s.length>0&&t.state!=="maximized"){const{width:u,height:d}=s[0],f=d/u*p-g;f!==0&&e.isWritable&&e.emitter.emit("setBoxSize",{width:t.intrinsicWidth,height:t.intrinsicHeight+f/t.rootRect.height})}n.remove(h)};return o.view.callbacks.once("onSizeUpdated",a),()=>o.view.callbacks.off("onSizeUpdated",a)})}}export{T as DocsViewer,re as NetlessAppDocsViewer,G as PageRenderer,X as ScrollBar,O as Stepper,re as default};
