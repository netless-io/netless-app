var K=Object.defineProperty;var Q=(t,e,s)=>e in t?K(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var p=(t,e,s)=>(Q(t,typeof e!="symbol"?e+"":e,s),s);import{Z as Y,L as ee,o as O,R as te,$ as U,_ as se,a0 as ne}from"./index-13a0c33f.js";import{a1 as Ne}from"./index-13a0c33f.js";import"./modulepreload-polyfill-ec808ebb.js";const L="netless-app-slide",G="https://convertcdn.netless.link/dynamicConvert";function T(){}function F(t){return document.createElement(t)}function _(t,e){const s=F(t);return oe(s,e),s}function R(t,e){return t.appendChild(e)}function y(t){return`${L}-${t}`}function oe(t,e){t.className=y(e)}function ie(t){return t.endsWith("/")?t.slice(0,-1):t}function B(t,e){if(typeof t=="object"&&t!==null)return t[e]}function W(){let t;return[new Promise(s=>{t=s}),t]}function re(t){const e=t.room,s=t.displayer;return e?()=>e.calibrationTimestamp:s?()=>s.beginTimestamp+s.progressTime:()=>Date.now()}function H(t){try{let e=window.getComputedStyle(t).backgroundColor;if(e!=="rgba(0, 0, 0, 0)"&&e!=="transparent")return e=ae(e),console.log("[Slide] guess bg color:",e),e;if(t.parentElement)return H(t.parentElement)}catch{}return"#ffffff"}function ae(t){const e=Y.get(t);if(e&&e.model==="rgb"){const s=e.value,i=(((Math.round(s[0])&255)<<16)+((Math.round(s[1])&255)<<8)+(Math.round(s[2])&255)).toString(16);return"#"+"000000".substring(i.length)+i}else return t}function X(t,e){return`${ie(e||G)}/${t}`}async function le({taskId:t,url:e}){const s=X(t,e),n=`${s}/preview/1.png`,i=`${s}/jsonOutput/slide-1.json`,l=new Promise(r=>{const d=new Image;d.onload=()=>r(d),d.onerror=()=>r(null),d.src=n}),o=fetch(i).then(r=>r.json());return{preview:await l,slide:await o}}function de(t){if(typeof document<"u"){const e=()=>t(document.visibilityState==="visible");return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)}return T}const ce=`.netless-app-slide-tele-fancy-scrollbar{overscroll-behavior:contain;overflow:auto;overflow-y:scroll;overflow-y:overlay;-webkit-overflow-scrolling:touch;-ms-overflow-style:-ms-autohiding-scrollbar;scrollbar-width:auto}.netless-app-slide-tele-fancy-scrollbar::-webkit-scrollbar{height:8px;width:8px}.netless-app-slide-tele-fancy-scrollbar::-webkit-scrollbar-track{background-color:transparent}.netless-app-slide-tele-fancy-scrollbar::-webkit-scrollbar-thumb{background-color:#444e601a;background-color:transparent;border-radius:4px;transition:background-color .4s}.netless-app-slide-tele-fancy-scrollbar:hover::-webkit-scrollbar-thumb{background-color:#444e601a}.netless-app-slide-tele-fancy-scrollbar::-webkit-scrollbar-thumb:hover{background-color:#444e6033}.netless-app-slide-tele-fancy-scrollbar::-webkit-scrollbar-thumb:active{background-color:#444e6033}.netless-app-slide-tele-fancy-scrollbar::-webkit-scrollbar-thumb:vertical{min-height:50px}.netless-app-slide-tele-fancy-scrollbar::-webkit-scrollbar-thumb:horizontal{min-width:50px}.netless-app-slide-content{position:relative;height:100%;overflow:hidden}.netless-app-slide-slide{width:100%;height:100%;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-slide-preview-mask{display:none;position:absolute;z-index:10200;top:0;left:0;width:100%;height:100%}.netless-app-slide-preview{display:flex;flex-direction:column;align-items:center;position:absolute;z-index:10300;top:0;left:0;width:33%;max-width:200px;height:100%;padding-top:10px;transform:translate(-100%);background:rgba(237,237,240,.9);box-shadow:inset -1px 0 #0000001c;transition:transform .4s;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-slide-preview-active .netless-app-slide-preview-mask{display:block}.netless-app-slide-preview-active .netless-app-slide-preview{transform:translate(0)}.netless-app-slide-preview-page{position:relative;display:block;width:55%;margin-bottom:10px;font-size:0;color:transparent;outline:none;border:7px solid transparent;border-radius:4px;transition:border-color .3s;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-slide-preview-page:hover,.netless-app-slide-preview-page.netless-app-slide-preview-page-active{border-color:#444e601a}.netless-app-slide-preview-page>img{width:100%;height:auto;box-sizing:border-box;border:1px solid rgba(0,0,0,.5);border-radius:1px;background-color:#fff;box-shadow:0 2px 8px #0000004d}.netless-app-slide-preview-page-name{position:absolute;top:1px;left:-10px;transform:translate(-100%);text-align:right;font-size:12px;color:#5f5f5f;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.netless-app-slide-overlay{display:flex;align-items:center;justify-content:center;position:absolute;z-index:10100;top:0;left:0;width:100%;height:100%;padding:10px;box-sizing:border-box;background:rgba(255,0,0,.25);transition:opacity .3s;opacity:0;pointer-events:none}.netless-app-slide-footer{box-sizing:border-box;height:26px;display:flex;align-items:center;padding:0 16px;border-top:1px solid #eeeef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}.netless-app-slide-float-footer{width:100%;min-height:26px;position:absolute;left:0;bottom:0;z-index:2000;background:rgba(249,249,252,.9);transition:opacity .4s}.netless-app-slide-footer-btn{box-sizing:border-box;width:26px;height:26px;font-size:0;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;cursor:pointer;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}.netless-app-slide-footer-btn:hover{background:rgba(237,237,240,.9)}@media (hover: none){.netless-app-slide-footer-btn:hover{background:transparent!important}}.netless-app-slide-footer-btn>svg{width:100%;height:100%}.netless-app-slide-footer-btn>svg:nth-of-type(2){display:none}.netless-app-slide-footer-btn.netless-app-slide-footer-btn-playing>svg:nth-of-type(1){display:none}.netless-app-slide-footer-btn.netless-app-slide-footer-btn-playing>svg:nth-of-type(2){display:initial}.netless-app-slide-footer-btn~.netless-app-slide-footer-btn{margin-left:15px}.netless-app-slide-page-jumps{flex:1;display:flex;justify-content:center;align-items:center}.netless-app-slide-page-number{display:flex;align-items:center;height:26px;margin-left:auto;font-size:13px;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap;word-break:keep-all;font-variant-numeric:tabular-nums}.netless-app-slide-page-number-input{border:none;outline:none;width:3em;margin:0;padding:0 .5em 0 2px;text-align:right;font-size:13px;line-height:1;font-weight:400;border-radius:2px;color:currentColor;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";background:transparent;transition:background .4s;font-variant-numeric:tabular-nums;-webkit-tap-highlight-color:rgba(0,0,0,0)}.netless-app-slide-page-number-input:hover,.netless-app-slide-page-number-input:focus,.netless-app-slide-page-number-input:active{user-select:text;background:#fff;box-shadow:#63636333 0 2px 8px}.netless-app-slide-readonly .netless-app-slide-footer-btn{cursor:not-allowed}.netless-app-slide-readonly .netless-app-slide-footer-btn:hover{background:transparent}.netless-app-slide-readonly .netless-app-slide-page-number-input{cursor:not-allowed}.netless-app-slide-readonly .netless-app-slide-page-number-input:hover,.netless-app-slide-readonly .netless-app-slide-page-number-input:focus,.netless-app-slide-readonly .netless-app-slide-page-number-input:active{background:transparent;box-shadow:none}.netless-app-slide-readonly .netless-app-slide-page-number-input:disabled{color:inherit}.netless-app-slide-readonly.netless-app-slide-float-footer,.netless-app-slide-wb-view-hidden{display:none}.telebox-color-scheme-dark .netless-app-slide-page-number-input:active,.telebox-color-scheme-dark .netless-app-slide-page-number-input:focus,.telebox-color-scheme-dark .netless-app-slide-page-number-input:hover{color:currentColor;background:#25282e}.telebox-color-scheme-dark .netless-app-slide-footer{border-top:none}.telebox-color-scheme-dark .netless-app-slide-footer-btn:hover{background:#212126}.telebox-color-scheme-dark .netless-app-slide-preview{background:rgba(50,50,50,.9)}.netless-app-slide-preview-wrapper{width:100%;height:100%;overflow:hidden;display:flex;flex-flow:column nowrap}.netless-app-slide-preview-wrapper .netless-app-slide-content{flex:1}.netless-app-slide-preview-wrapper .netless-app-slide-footer{flex-shrink:0}
`;function pe(t){const e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("class",`${t}-footer-icon-sidebar`),s.setAttribute("viewBox","0 0 64 64");const n=document.createElementNS(e,"path");return n.setAttribute("fill","currentColor"),n.setAttribute("d","M50 8H14c-3.309 0-6 2.691-6 6v36c0 3.309 2.691 6 6 6h36c3.309 0 6-2.691 6-6V14c0-3.309-2.691-6-6-6zM12 50V14c0-1.103.897-2 2-2h8v40h-8c-1.103 0-2-.897-2-2zm40 0c0 1.103-.897 2-2 2H26V12h24c1.103 0 2 .897 2 2z"),s.appendChild(n),s}function ue(t){const e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("class",`${t}-footer-icon-arrow-left`),s.setAttribute("viewBox","0 0 500 500");const n=document.createElementNS(e,"path");return n.setAttribute("fill","currentColor"),n.setAttribute("d","M177.81 249.959L337.473 90.295c2.722-2.865 2.651-7.378-.143-10.1-2.793-2.65-7.163-2.65-9.956 0l-164.75 164.75c-2.793 2.793-2.793 7.306 0 10.1l164.75 164.75c2.865 2.722 7.378 2.65 10.099-.143 2.651-2.794 2.651-7.163 0-9.957L177.809 249.959z"),s.appendChild(n),s}function he(t){const e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("class",`${t}-footer-icon-play`),s.setAttribute("viewBox","0 0 500 500");const n=document.createElementNS(e,"path");return n.setAttribute("fill","currentColor"),n.setAttribute("d","M418.158 257.419L174.663 413.33c-6.017 3.919-15.708 3.772-21.291-.29-2.791-2.018-4.295-4.483-4.295-7.084V94.109c0-5.65 6.883-10.289 15.271-10.289 4.298 0 8.391 1.307 11.181 3.332l242.629 155.484c6.016 3.917 6.451 10.292.649 14.491-.216.154-.432.154-.649.292zM170.621 391.288l223.116-141.301L170.71 107.753l-.089 283.535z"),s.appendChild(n),s}function fe(t){const e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("class",`${t}-footer-icon-pause`),s.setAttribute("viewBox","0 0 500 500");const n=document.createElementNS(e,"path");return n.setAttribute("fill","currentColor"),n.setAttribute("d","M312.491 78.261c0-6.159 4.893-11.213 11.04-11.213 6.158 0 11.211 5.054 11.211 11.213v343.478c0 6.159-5.053 11.213-11.211 11.213-6.147 0-11.04-5.054-11.04-11.213V78.261zM165.257 78.261c0-6.159 4.893-11.213 11.04-11.213 6.158 0 11.211 5.054 11.211 11.213v343.478c0 6.159-5.053 11.213-11.211 11.213-6.147 0-11.04-5.054-11.04-11.213V78.261z"),s.appendChild(n),s}function ge(t){const e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("class",`${t}-footer-icon-arrow-right`),s.setAttribute("viewBox","0 0 500 500");const n=document.createElementNS(e,"path");return n.setAttribute("fill","currentColor"),n.setAttribute("d","M322.19 250.041L162.527 409.705c-2.722 2.865-2.651 7.378.143 10.1 2.793 2.65 7.163 2.65 9.956 0l164.75-164.75c2.793-2.793 2.793-7.306 0-10.1l-164.75-164.75c-2.865-2.722-7.378-2.65-10.099.143-2.651 2.794-2.651 7.163 0 9.957l159.664 159.736z"),s.appendChild(n),s}function be(t){const e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("class",`${t}-footer-icon-save`),s.setAttribute("viewBox","0 0 448 512");const n=document.createElementNS(e,"path");return n.setAttribute("fill","currentColor"),n.setAttribute("d","M224 256c-35.2 0-64 28.8-64 64c0 35.2 28.8 64 64 64c35.2 0 64-28.8 64-64C288 284.8 259.2 256 224 256zM433.1 129.1l-83.9-83.9C341.1 37.06 328.8 32 316.1 32H64C28.65 32 0 60.65 0 96v320c0 35.35 28.65 64 64 64h320c35.35 0 64-28.65 64-64V163.9C448 151.2 442.9 138.9 433.1 129.1zM128 80h144V160H128V80zM400 416c0 8.836-7.164 16-16 16H64c-8.836 0-16-7.164-16-16V96c0-8.838 7.164-16 16-16h16v104c0 13.25 10.75 24 24 24h192C309.3 208 320 197.3 320 184V83.88l78.25 78.25C399.4 163.2 400 164.8 400 166.3V416z"),s.appendChild(n),s}function me(t){const e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("class",`${t}-footer-icon-spinner`),s.setAttribute("viewBox","0 0 512 512");const n=document.createElementNS(e,"path");n.setAttribute("fill","currentColor"),n.setAttribute("d","M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z");const i=document.createElementNS(e,"animateTransform");i.setAttribute("attributeName","transform"),i.setAttribute("attributeType","xml"),i.setAttribute("type","rotate"),i.setAttribute("from","0 256 256"),i.setAttribute("to","360 256 256"),i.setAttribute("begin","0s"),i.setAttribute("dur","2s"),i.setAttribute("fill","freeze"),i.setAttribute("repeatCount","indefinite"),n.appendChild(i);const l=document.createElementNS(e,"text");return l.setAttribute("x","125"),l.setAttribute("y","345"),l.setAttribute("data-id","progress"),l.style.fontSize="246px",l.textContent="20",s.appendChild(l),s.appendChild(n),s}function we(){let t=T;const e=u=>{t=u};let s=T;const n=u=>{s=u};let i=T;const l=u=>{i=u};let o=!1,r=!1,d=0,f=0;const b=_("div","footer"),g=_("button","btn-sidebar");g.classList.add(y("footer-btn")),g.appendChild(pe(L)),g.onclick=function(){o||s()},g.style.display="none",b.appendChild(g);const m=_("div","page-jumps"),a=_("button","btn-page-back");a.classList.add(y("footer-btn")),a.appendChild(ue(L)),a.onclick=function(){o||t(d-1)},m.appendChild(a);const h=_("button","btn-page-play");h.classList.add(y("footer-btn")),h.appendChild(he(L)),h.appendChild(fe(L));let k=0;h.onclick=function(){o||(h.classList.add(y("footer-btn-playing")),i(),clearTimeout(k),k=window.setTimeout(()=>{h.classList.remove(y("footer-btn-playing"))},500))},m.appendChild(h);const A=_("button","btn-page-next");A.classList.add(y("footer-btn")),A.appendChild(ge(L)),A.onclick=function(){o||t(d+1)},m.appendChild(A);const C=_("div","page-number"),w=_("input","page-number-input");w.value=String(d+1),w.onchange=function(){o||w.value&&t(Number(w.value)-1)};const c=_("span","total-page");c.textContent=" / ",C.appendChild(w),C.appendChild(c),b.appendChild(m),b.appendChild(C);const v=y("readonly");let S=T;const x=u=>{S=u},$=u=>{if(u<99){z.style.display="block",E.style.display="none";const D=z.querySelector("[data-id]");D&&(D.textContent=u.toString().padStart(2,"0"))}else z.style.display="none",E.style.display="block"},E=be(L),z=me(L);z.style.display="none";const P=_("button","footer-btn");P.appendChild(E),P.onclick=function(){S($)},P.appendChild(z);function N(u){o!==u&&(o=u,b.classList.toggle(v,o),w.disabled=o)}function q(u){r!==u&&(r=u,g.style.display=r?"":"none")}function J(u,D=!1){(D||d!==u)&&(d=u,w.value=String(d+1))}function Z(u){f!==u&&(f=u,c.textContent=` / ${f}`)}return{$footer:b,$pageNumberInput:w,set_readonly:N,set_sidebar:q,set_page_index:J,set_page_count:Z,on_new_page_index:e,on_toggle_preview:n,on_play:l,on_save_to_pdf:x}}function ve(){let t=T;const e=c=>{t=c};let s=!1,n=!1,i=!1,l=[],o=0;const r=y("readonly"),d=y("preview-active"),f=_("div","content"),b=_("div","preview-mask");b.onclick=function(v){n||v.target===b&&h(!1)},R(f,b);const g=_("div","preview");g.classList.add(y("tele-fancy-scrollbar")),g.onclick=function(v){var x;if(n)return;const S=(x=v.target.dataset)==null?void 0:x.pageIndex;S&&(v.preventDefault(),v.stopPropagation(),v.stopImmediatePropagation(),t(Number(S)),h(!1))},R(f,g);let m;function a(c){n!==c&&(n=c,f.classList.toggle(r,n))}function h(c){i!==c&&(i=c,f.classList.toggle(d,i),i&&!m&&(m=new ee({container:g,elements_selector:`.${y("preview-page>img")}`})))}function k(c){if(l!==c){l=c;const v=y("preview-page"),S=y("preview-page-name");l.forEach((x,$)=>{const E=String($),z=F("a");z.className=v+" "+y(`preview-page-${$}`),z.href="#",z.dataset.pageIndex=E;const P=F("span");P.className=S,P.textContent=String($+1),P.dataset.pageIndex=E;const N=F("img");N.width=x.width,N.height=x.height,N.alt=`page-${$}`,N.dataset.src=x.thumbnail,N.dataset.pageIndex=E,R(z,N),R(z,P),R(g,z)}),s||m==null||m.update()}}function A(c,v=!1){if(v||o!==c){o=c;const S=g.querySelector(`.${y(`preview-page-${o}`)}`);S&&g.scrollTo({top:S.offsetTop-16})}}function C(){s=!0,m==null||m.destroy()}function w(){return i}return{$content:f,$preview:g,set_readonly:a,set_active:h,get_active:w,set_pages:k,on_new_page_index:e,set_page_index:A,destroy:C}}const V=class{constructor(e){p(this,"sideEffect",new O);p(this,"events",new te);p(this,"$slide",_("div","slide"));p(this,"$overlay",_("div","overlay"));p(this,"sidebar",ve());p(this,"footer",we());p(this,"$content");p(this,"$footer");p(this,"slide");p(this,"_slideTitle","");p(this,"_getWhiteSnapshot",null);p(this,"_readyPromise");p(this,"_infoPromise");p(this,"_ready",!1);p(this,"_slideCount",0);p(this,"_destroyed",!1);p(this,"_isFrozen",!1);p(this,"_cachedIsFrozen",!1);p(this,"onPlay",()=>{this.slide.nextStep()});p(this,"onNewPageIndex",e=>{this._ready&&e>=0&&e<this._slideCount?this.slide.renderSlide(e+1):this.setPage(this.slide.slideState.currentSlideIndex)});p(this,"onTogglePreview",()=>{this.sidebar.set_active(!this.sidebar.get_active())});p(this,"toPdf",async e=>{const n=document.createElement("canvas"),i=n.getContext("2d"),{slideCount:l,width:o,height:r}=this.slide;let d=Math.floor(o),f=Math.floor(r);d>1920&&(d=1920,f=Math.floor(r*d/o)),f>1920&&(f=1920,d=Math.floor(o*f/r)),n.width=d,n.height=f;const b=document.createElement("canvas");b.width=o,b.height=r;const g=b.getContext("2d");if(!g||!this._getWhiteSnapshot||!i)return null;const m=d>f?"l":"p",{jsPDF:a}=await se(()=>import("./jspdf.es.min-e0b4708e.js"),["./jspdf.es.min-e0b4708e.js","./index-13a0c33f.js","./modulepreload-polyfill-ec808ebb.js","./index-7e97d6a9.css"],import.meta.url),h=new a({format:[d,f],orientation:m,compress:!0});for(let c=1;c<=l;c++){const v=await this.slide.snapshotWithTimingEnd(c);if(v){const x=document.createElement("img");x.src=v,await new Promise($=>x.onload=$),i.drawImage(x,0,0,d,f)}g.clearRect(0,0,o,r),this._getWhiteSnapshot(c,b,g);try{const x=b.toDataURL("image/png"),$=document.createElement("img");$.src=x,await new Promise(E=>$.onload=E),i.drawImage($,0,0,d,f)}catch{}const S=n.toDataURL("image/jpeg",.6);c>1&&h.addPage(),h.addImage(S,"JPEG",0,0,d,f,"","FAST"),i.clearRect(0,0,d,f),e(Math.ceil(c/l*100))}const k=h.output("arraybuffer"),A=new Blob([k]),C=URL.createObjectURL(A),w=document.createElement("a");w.setAttribute("href",C),w.setAttribute("download",`${this._slideTitle||"snapshot"}.pdf`),w.style.display="none",document.body.appendChild(w),w.click(),document.body.removeChild(w),window.postMessage({type:"@app-slide/_download_pdf_",buf:k})});this.$content=this.sidebar.$content,this.$footer=this.footer.$footer,R(this.$content,this.$slide),R(this.$content,this.$overlay),this.sidebar.on_new_page_index(this.onNewPageIndex),this.footer.on_new_page_index(this.onNewPageIndex),this.footer.on_toggle_preview(this.onTogglePreview),this.footer.on_play(this.onPlay),this.footer.on_save_to_pdf(this.toPdf),this.sideEffect.push(this.sidebar.destroy),this.sideEffect.push(()=>this.slide.destroy()),this.sideEffect.push(()=>{this.$content.parentElement&&this.$content.remove(),this.$footer.parentElement&&this.$footer.remove(),this.$slide.parentElement&&this.$slide.remove()}),this.sideEffect.push(de(r=>{this._destroyed||(r?this._cachedIsFrozen||this.unfreeze():(this._cachedIsFrozen=this._isFrozen,this.freeze()))}));const[s,n]=W();this._infoPromise=s,V.fetchSlideInfo(e).then(({preview:r,slide:d})=>{if(!this._destroyed){if(this._slideCount=d.slideCount,r){const{taskId:f,url:b}=e,{slideCount:g}=d,{width:m,height:a}=r,h=X(f,b),k=Array.from({length:g},(A,C)=>({width:m,height:a,thumbnail:`${h}/preview/${C+1}.png`}));this.sidebar.set_pages(k),this.footer.set_sidebar(!0)}this.footer.set_page_count(d.slideCount),n(d)}}).catch(r=>{console.log("[Slide] fetch slide info error"),console.error(r),this.events.emit("prepareError",r)});const[l,o]=W();this._readyPromise=l,this.slide=new U.Slide({anchor:this.$slide,mode:"local",interactive:!0,enableGlobalClick:!0,useLocalCache:!0,...e}),this.slide.setResource(e.taskId,e.url||G),this.slide.on("renderStart",()=>{this._destroyed||this.events.emit("renderStart")}),this.slide.on("slideChange",r=>{this._destroyed||(this.setPage(r),this.$overlay.style.opacity="",this.events.emit("renderEnd"))}),this.slide.once("renderEnd",()=>{this._ready||setTimeout(()=>{this._ready=!0,o()},1e3)}),this.slide.on("renderError",r=>{this._destroyed||r.error&&(console.error(r.error),this.$overlay.textContent=`Error on slide.index=${r.index}: ${r.error.message}`,this.$overlay.style.opacity="1",this.events.emit("renderError",r))}),this.ready(()=>{this._isFrozen&&this.freeze()})}prepare(e){return this._infoPromise.then(e)}ready(e){return this._readyPromise.then(e)}destroy(){this._destroyed=!0,this.sideEffect.flushAll()}setReadonly(e){this.slide.setInteractive(!e),this.sidebar.set_readonly(e),this.footer.set_readonly(e)}setPage(e){this.sidebar.set_page_index(e-1,!0),this.footer.set_page_index(e-1,!0)}freeze(){this._destroyed||(this._isFrozen=!0,this._ready&&(this.slide.frozen(),this.events.emit("freeze")))}unfreeze(){this._destroyed||(this._isFrozen=!1,this._ready&&(this.slide.release(),this.events.emit("unfreeze")))}};let M=V;p(M,"styles",ce),p(M,"fetchSlideInfo",le);function ye(t){return t.displayer.logger}const I=class{constructor(e){p(this,"info",e=>{I.roomLogger&&this.context?I.roomLogger.info(e+` (${this.context.appId})`):this.context?console.debug(e+` (${this.context.appId})`):console.debug(e)});this.context=e,e&&(I.active.add(e.appId),I.roomLogger=ye(e))}destroy(){this.context&&I.active.delete(this.context.appId),I.active.size===0&&(I.roomLogger=null)}};let j=I;p(j,"active",new Set),p(j,"roomLogger",null);function _e({context:t,storage:e,viewer:s,sideEffect:n,logger:i}){const l=i.info.bind(i);let o=null;s.prepare(({width:a,height:h,slideCount:k})=>{t.destroyed||(a&&t.box.setStageRatio(h/a),o=t.createWhiteBoardView({size:k}),o.setBaseRect({width:a,height:h}),s._slideTitle=t.box.title,s._getWhiteSnapshot=(A,C,w)=>{if(!o)return null;const c=o.pageState.pages[A-1],{width:v,height:S}=o.view.size;C.width=v,C.height=S,o.view.screenshotToCanvas(w,c,v,S,o.view.camera)},f())});const{slide:r}=s;function d(a=e.state.state){return JSON.stringify(a)}function f(){if(e.state.state)l("[Slide] restore "+d()),r.setSlideState(e.state.state);else if(t.isAddApp)l("[Slide] kick start"),r.renderSlide(1);else{l("[Slide] wait for restore");const a=n.add(()=>{const k=setInterval(()=>{e.state.state||(l("[Slide] timeout"),r.renderSlide(1))},15e3);return()=>clearInterval(k)}),h=n.push(e.on("stateChanged",()=>{e.state.state&&(l("[Slide] restore "+d()),r.setSlideState(e.state.state),n.flush(h),n.flush(a))}))}}r.on("stateChange",()=>{e.isWritable&&e.setState({state:r.slideState})}),r.on("syncDispatch",a=>{t.isWritable&&(l("[Slide] dispatch "+d(B(a,"uuid"))),t.dispatchMagixEvent("syncDispatch",a))}),n.push(t.addMagixEventListener("syncDispatch",({payload:a})=>{l("[Slide] receive "+d(B(a,"uuid"))),r.emit("syncReceive",a)},{fireSelfEventAfterCommit:!0})),r.on("slideChange",a=>{t.isWritable&&o&&(l("[Slide] page to "+a),o.jumpPage(a-1))});function b(){o&&o.view.divElement&&o.view.divElement.classList.add(y("wb-view-hidden"))}function g(){o&&o.view.divElement&&o.view.divElement.classList.remove(y("wb-view-hidden"))}s.setReadonly(!t.isWritable),n.push([t.emitter.on("writableChange",()=>s.setReadonly(!t.isWritable)),s.events.on("renderStart",b),s.events.on("renderEnd",g)]);const m=a=>{if(!a)return!1;const h=a.tagName;return h==="INPUT"||h==="TEXTAREA"||h==="SELECT"};n.addEventListener(window,"keydown",a=>{!a||a.target.className==="telebox-quarantine-outer"||t.box.focus&&!t.box.readonly&&!m(a.target)&&((a.key==="ArrowUp"||a.key==="ArrowLeft")&&s.slide.prevStep(),(a.key==="ArrowRight"||a.key==="ArrowDown")&&s.slide.nextStep())})}function Ce(t){const{container:e,...s}=t,n=_("div","preview-wrapper"),i=new M(s);return n.appendChild(document.createElement("style")).textContent=M.styles,n.appendChild(i.$content),n.appendChild(i.$footer),e.appendChild(n),i.prepare(()=>i.slide.renderSlide(1)),i}const $e=U.Slide.usePlugin.bind(U.Slide),ze=void 0,Ae={kind:"Slide",config:{enableShadowDOM:!1},setup(t){console.log("[Slide] setup @ "+void 0+" ("+t.appId+")");const e=new j(t);if(e.info("[Slide] setup @ "+void 0),!t.attributes.taskId)throw new Error("[Slide] no taskId");const s=t.createStorage("slide",t.attributes),n=t.getAppOptions()||{},i=n.renderOptions||{},l=new O,o=new M({interactive:!0,mode:"interactive",enableGlobalClick:!0,timestamp:re(t),logger:n.logger||e,renderOptions:{minFPS:i.minFPS||25,maxFPS:i.maxFPS||30,autoFPS:i.autoFPS??!0,autoResolution:i.autoResolution??!0,resolution:i.resolution,maxResolutionLevel:i.maxResolutionLevel,transactionBgColor:i.transactionBgColor||H(t.box.$content)},rtcAudio:n.rtcAudio,useLocalCache:n.useLocalCache,resourceTimeout:n.resourceTimeout,loaderDelegate:n.loaderDelegate,navigatorDelegate:n.navigatorDelegate,fixedFrameSize:n.fixedFrameSize,taskId:s.state.taskId,url:s.state.url});return Object.assign(o,{context:t,logger:e}),l.push(ne.set(t.appId,o,t.box)),l.push(o.events.on("freeze",()=>e.info("[Slide] freeze"))),l.push(o.events.on("unfreeze",()=>e.info("[Slide] unfreeze"))),l.push(o.events.on("prepareError",r=>e.info("[Slide] fetch slide info failed: "+r.message))),l.push(o.events.on("renderError",({error:r,index:d})=>e.info(`[Slide] render failed [${d}]: ${r.message}`))),t.box.mountStyles(M.styles),t.box.mountStage(o.$slide),t.box.mountFooter(o.$footer),t.box.mountContent(o.$content),l.push(()=>o.destroy()),_e({context:t,storage:s,viewer:o,sideEffect:l,logger:e}),t.emitter.on("destroy",()=>{e.info("[Slide] destroy"),e.destroy(),l.flushAll()}),o}},Ee=U.Slide;export{G as DefaultUrl,Ee as Slide,M as SlideViewer,Ne as addHooks,Ae as default,Ce as previewSlide,ne as refrigerator,$e as usePlugin,ze as version};
