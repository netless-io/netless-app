var ee=Object.defineProperty,te=Object.defineProperties;var re=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var J=(t,e,r)=>e in t?ee(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,k=(t,e)=>{for(var r in e||(e={}))ie.call(e,r)&&J(t,r,e[r]);if(H)for(var r of H(e))se.call(e,r)&&J(t,r,e[r]);return t},K=(t,e)=>te(t,re(e));import{o as ne}from"./side-effect-manager.es.789c7667.js";import{e as oe}from"./ensure-attributes.2c659353.js";const b=new WeakMap,D=new WeakMap,w=new WeakMap,O=Symbol("anyProducer"),V=Promise.resolve(),v=Symbol("listenerAdded"),R=Symbol("listenerRemoved");let T=!1;function m(t){if(typeof t!="string"&&typeof t!="symbol")throw new TypeError("eventName must be a string or a symbol")}function C(t){if(typeof t!="function")throw new TypeError("listener must be a function")}function S(t,e){const r=D.get(t);return r.has(e)||r.set(e,new Set),r.get(e)}function A(t,e){const r=typeof e=="string"||typeof e=="symbol"?e:O,i=w.get(t);return i.has(r)||i.set(r,new Set),i.get(r)}function ae(t,e,r){const i=w.get(t);if(i.has(e))for(const s of i.get(e))s.enqueue(r);if(i.has(O)){const s=Promise.all([e,r]);for(const n of i.get(O))n.enqueue(s)}}function F(t,e){e=Array.isArray(e)?e:[e];let r=!1,i=()=>{},s=[];const n={enqueue(o){s.push(o),i()},finish(){r=!0,i()}};for(const o of e)A(t,o).add(n);return{async next(){return s?s.length===0?r?(s=void 0,this.next()):(await new Promise(o=>{i=o}),this.next()):{done:!1,value:await s.shift()}:{done:!0}},async return(o){s=void 0;for(const u of e)A(t,u).delete(n);return i(),arguments.length>0?{done:!0,value:await o}:{done:!0}},[Symbol.asyncIterator](){return this}}}function Q(t){if(t===void 0)return X;if(!Array.isArray(t))throw new TypeError("`methodNames` must be an array of strings");for(const e of t)if(!X.includes(e))throw typeof e!="string"?new TypeError("`methodNames` element must be a string"):new Error(`${e} is not Emittery method`);return t}const $=t=>t===v||t===R;class h{static mixin(e,r){return r=Q(r),i=>{if(typeof i!="function")throw new TypeError("`target` must be function");for(const o of r)if(i.prototype[o]!==void 0)throw new Error(`The property \`${o}\` already exists on \`target\``);function s(){return Object.defineProperty(this,e,{enumerable:!1,value:new h}),this[e]}Object.defineProperty(i.prototype,e,{enumerable:!1,get:s});const n=o=>function(...u){return this[e][o](...u)};for(const o of r)Object.defineProperty(i.prototype,o,{enumerable:!1,value:n(o)});return i}}static get isDebugEnabled(){if(typeof process!="object")return T;const{env:e}=process||{env:{}};return e.DEBUG==="emittery"||e.DEBUG==="*"||T}static set isDebugEnabled(e){T=e}constructor(e={}){b.set(this,new Set),D.set(this,new Map),w.set(this,new Map),this.debug=e.debug||{},this.debug.enabled===void 0&&(this.debug.enabled=!1),this.debug.logger||(this.debug.logger=(r,i,s,n)=>{n=JSON.stringify(n),typeof s=="symbol"&&(s=s.toString());const o=new Date,u=`${o.getHours()}:${o.getMinutes()}:${o.getSeconds()}.${o.getMilliseconds()}`;console.log(`[${u}][emittery:${r}][${i}] Event Name: ${s}
	data: ${n}`)})}logIfDebugEnabled(e,r,i){(h.isDebugEnabled||this.debug.enabled)&&this.debug.logger(e,this.debug.name,r,i)}on(e,r){C(r),e=Array.isArray(e)?e:[e];for(const i of e)m(i),S(this,i).add(r),this.logIfDebugEnabled("subscribe",i,void 0),$(i)||this.emit(v,{eventName:i,listener:r});return this.off.bind(this,e,r)}off(e,r){C(r),e=Array.isArray(e)?e:[e];for(const i of e)m(i),S(this,i).delete(r),this.logIfDebugEnabled("unsubscribe",i,void 0),$(i)||this.emit(R,{eventName:i,listener:r})}once(e){return new Promise(r=>{const i=this.on(e,s=>{i(),r(s)})})}events(e){e=Array.isArray(e)?e:[e];for(const r of e)m(r);return F(this,e)}async emit(e,r){m(e),this.logIfDebugEnabled("emit",e,r),ae(this,e,r);const i=S(this,e),s=b.get(this),n=[...i],o=$(e)?[]:[...s];await V,await Promise.all([...n.map(async u=>{if(i.has(u))return u(r)}),...o.map(async u=>{if(s.has(u))return u(e,r)})])}async emitSerial(e,r){m(e),this.logIfDebugEnabled("emitSerial",e,r);const i=S(this,e),s=b.get(this),n=[...i],o=[...s];await V;for(const u of n)i.has(u)&&await u(r);for(const u of o)s.has(u)&&await u(e,r)}onAny(e){return C(e),this.logIfDebugEnabled("subscribeAny",void 0,void 0),b.get(this).add(e),this.emit(v,{listener:e}),this.offAny.bind(this,e)}anyEvent(){return F(this)}offAny(e){C(e),this.logIfDebugEnabled("unsubscribeAny",void 0,void 0),this.emit(R,{listener:e}),b.get(this).delete(e)}clearListeners(e){e=Array.isArray(e)?e:[e];for(const r of e)if(this.logIfDebugEnabled("clear",r,void 0),typeof r=="string"||typeof r=="symbol"){S(this,r).clear();const i=A(this,r);for(const s of i)s.finish();i.clear()}else{b.get(this).clear();for(const i of D.get(this).values())i.clear();for(const i of w.get(this).values()){for(const s of i)s.finish();i.clear()}}}listenerCount(e){e=Array.isArray(e)?e:[e];let r=0;for(const i of e){if(typeof i=="string"){r+=b.get(this).size+S(this,i).size+A(this,i).size+A(this).size;continue}typeof i!="undefined"&&m(i),r+=b.get(this).size;for(const s of D.get(this).values())r+=s.size;for(const s of w.get(this).values())r+=s.size}return r}bindMethods(e,r){if(typeof e!="object"||e===null)throw new TypeError("`target` must be an object");r=Q(r);for(const i of r){if(e[i]!==void 0)throw new Error(`The property \`${i}\` already exists on \`target\``);Object.defineProperty(e,i,{enumerable:!1,value:this[i].bind(this)})}}}const X=Object.getOwnPropertyNames(h.prototype).filter(t=>t!=="constructor");Object.defineProperty(h,"listenerAdded",{value:v,writable:!1,enumerable:!0,configurable:!1});Object.defineProperty(h,"listenerRemoved",{value:R,writable:!1,enumerable:!0,configurable:!1});var ce=h;function Y(t,e,r){return{sceneState:{sceneName:`${t}`,scenePath:`${r}/${t}`,contextPath:r,scenes:Z(e),index:t-1}}}function Z(t){const e=[];for(let r=1;r<=t;++r)e.push({name:String(r)});return e}function de(t){return Math.max(1,t-1)}function le(t,e){return Math.min(e,t+1)}const ue=350;var l;(function(t){t.Init="Init",t.AttributesUpdate="AttributesUpdate",t.SetAttributes="SetAttributes",t.RegisterMagixEvent="RegisterMagixEvent",t.RemoveMagixEvent="RemoveMagixEvent",t.RemoveAllMagixEvent="RemoveAllMagixEvent",t.RoomStateChanged="RoomStateChanged",t.DispatchMagixEvent="DispatchMagixEvent",t.ReceiveMagixEvent="ReciveMagixEvent",t.NextPage="NextPage",t.PrevPage="PrevPage",t.SDKCreate="SDKCreate",t.OnCreate="OnCreate",t.SetPage="SetPage",t.GetAttributes="GetAttributes",t.Ready="Ready",t.Destroy="Destory",t.StartCreate="StartCreate",t.WrapperDidUpdate="WrapperDidUpdate",t.DisplayIframe="DisplayIframe",t.HideIframe="HideIframe",t.PageTo="PageTo"})(l||(l={}));var j;(function(t){t.WrapperDidMount="WrapperDidMount",t.IframeLoad="IframeLoad"})(j||(j={}));const fe=new Set(["clicker","selector"]),he={kind:"IframeBridge",setup(t){const e=t.getBox(),r=t.getView(),i=t.getDisplayer(),s=t.getRoom(),n=oe(t,{src:"about:blank",displaySceneDir:"/h5",lastEvent:null,state:{},page:0,maxPage:0}),o=new ne,u=document.createElement("div");Object.assign(u.style,{width:"100%",height:"100%",position:"relative"});const f=document.createElement("iframe");Object.assign(f.style,{width:"100%",height:"100%",border:"none",display:"block"}),u.appendChild(f),e.mountContent(u);let x=()=>{};const I=d=>fe.has(d);if(r){const d=document.createElement("div");Object.assign(d.style,{width:"100%",height:"100%",position:"absolute",top:0,left:0,overflow:"hidden"}),u.appendChild(d),t.mountView(d),r.disableCameraTransform=!0,o.add(()=>{const c=()=>{const P=u.getBoundingClientRect().height/ue;r.moveCamera({scale:P,animationMode:"immediately"})},a=new ResizeObserver(c);return a.observe(u),()=>a.disconnect()}),x=c=>{d.style.pointerEvents=c?"none":"auto"},x(I(s==null?void 0:s.state.memberState.currentApplianceName))}const L=d=>K(k({},d),{url:n.src,displaySceneDir:n.displaySceneDir,width:f.scrollWidth,height:f.scrollHeight,useClicker:!0,lastEvent:n.lastEvent}),y=new ce,E=new Map,W=()=>{E.forEach((d,c)=>{i.removeMagixEventListener(c,d)}),E.clear()},B=(...d)=>!1,g=d=>{var c;B("[IframeBridge] postMessage %s %O",d.kind,d.payload),(c=f.contentWindow)==null||c.postMessage(JSON.parse(JSON.stringify(d)),"*")},M=(d,c)=>{t.getIsWritable()&&(t.updateAttributes(["lastEvent"],{name:d,payload:c}),s==null||s.dispatchMagixEvent(d,c))},U=()=>{g({kind:l.Init,payload:{attributes:L(n.state),roomState:i.state,currentPage:n.page,observerId:i.observerId}})};let z=n.src.includes("cocos");const G=d=>{U(),y.emit(j.IframeLoad,d),y.on(l.Ready,()=>{var c,a;((c=n.lastEvent)==null?void 0:c.payload)&&g((a=n.lastEvent)==null?void 0:a.payload)}),z&&(setTimeout(()=>{g({kind:l.RoomStateChanged,payload:Y(1,n.maxPage,n.displaySceneDir)})},500),z=!1),f.removeEventListener("load",G)};o.addEventListener(f,"load",G);let _=0;const N=()=>{_++<3&&(f.src=n.src)};o.addEventListener(f,"error",N),f.src=n.src,o.add(()=>t.mobxUtils.autorun(()=>{g({kind:l.AttributesUpdate,payload:L(n.state)})})),o.add(()=>t.mobxUtils.autorun(()=>{f.src=n.src})),o.add(()=>t.mobxUtils.autorun(()=>{g({kind:l.RoomStateChanged,payload:Y(n.page,n.maxPage,n.displaySceneDir)})}));const q={emitter:y,postMessage:g,context:t};return y.emit(l.StartCreate),y.emit(l.OnCreate,q),s&&o.add(()=>{const d=c=>{c.memberState&&x(I(c.memberState.currentApplianceName))};return s.callbacks.on("onRoomStateChanged",d),()=>s.callbacks.off("onRoomStateChanged",d)}),o.addEventListener(window,"message",d=>{if(d.source!==f.contentWindow)return;const c=d.data;switch(B("[IframeBridge] received",c.kind,c.payload),c.kind){case l.SetAttributes:{t.updateAttributes(["state"],k(k({},n.state),c.payload));break}case l.RegisterMagixEvent:{const a=P=>{P.authorId!==i.observerId&&g({kind:l.ReceiveMagixEvent,payload:P})},p=c.payload;E.set(p,a),i.addMagixEventListener(p,a);break}case l.RemoveMagixEvent:{const a=c.payload,p=E.get(a);i.removeMagixEventListener(a,p);break}case l.DispatchMagixEvent:{const a=c.payload;M(a.event,a.payload);break}case l.RemoveAllMagixEvent:{W();break}case l.NextPage:{if(t.getIsWritable()&&s){const a=le(n.page,n.maxPage);if(a===n.page)break;t.setScenePath([n.displaySceneDir,a].join("/")),t.updateAttributes(["page"],a),M(l.NextPage,{})}break}case l.PrevPage:{if(t.getIsWritable()&&s){const a=de(n.page);if(a===n.page)break;t.setScenePath([n.displaySceneDir,a].join("/")),t.updateAttributes(["page"],a),M(l.PrevPage,{})}break}case l.SetPage:{const a=Number(c.payload)||0;if(t.getIsWritable()&&s)if(!a)s.removeScenes(n.displaySceneDir);else{const p=s.entireScenes()[n.displaySceneDir];(!p||p.length!==a)&&(s.removeScenes(n.displaySceneDir),s.putScenes(n.displaySceneDir,Z(a))),t.setScenePath(`${n.displaySceneDir}/1`),t.updateAttributes(["maxPage"],a)}break}case l.PageTo:{const a=c.payload;if(t.getIsWritable()&&s){if(!Number.isSafeInteger(a)||a<=0)break;t.setScenePath(`${n.displaySceneDir}/${a}`),t.updateAttributes(["page"],a),M(l.PageTo,a-1)}break}case l.SDKCreate:{U();break}case l.GetAttributes:{g({kind:l.GetAttributes,payload:L(n.state)});break}default:console.warn(`[IframeBridge]: unknown event kind "${c.kind}"`)}}),t.emitter.on("destroy",()=>{console.log("[IframeBridge]: destroy"),y.emit(l.Destroy),o.flushAll(),W(),f.remove()}),q}};export{he as default};
