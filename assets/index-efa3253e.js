import{o as m,a2 as S}from"./index-13a0c33f.js";import{L as N}from"./logger-37661953.js";import"./modulepreload-polyfill-ec808ebb.js";import"./randomColor-1ee64036.js";function R(e){var a;const t=e.room,s=e.displayer,n=s.observerId,o=(a=s.state.roomMembers.find(d=>d.memberId===n))==null?void 0:a.payload,h=(t==null?void 0:t.uid)||(o==null?void 0:o.uid)||"",i=(o==null?void 0:o.nickName)||h;return{memberId:n,uid:h,nickName:i}}function L(e){const t=e.indexOf("?",1);return t!==-1?{search:e.slice(t),pathname:e.slice(0,t)}:{search:"",pathname:e}}function M(e,t){const{pathname:s,search:n}=L(e);return s+(n?`${n}&`:"?")+t}function l(e){return document.createElement(e)}function u(e,t,s){s==null?e.removeAttribute(t):e.setAttribute(t,s)}function g(e,t){return e.appendChild(t)}function x(e){var t;return(t=e.parentNode)==null?void 0:t.removeChild(e)}const _=Promise.resolve();function b(e){const t=[];return{get value(){return e},set(s){e=s,t.forEach(n=>n(e))},subscribe(s){return t.push(s),_.then(()=>s(e)),()=>{t.splice(t.indexOf(s),1)}}}}const C=`.app-talkative-container{width:100%;height:100%;overflow:hidden;display:flex;justify-content:center;align-items:center;flex-direction:column}.app-talkative-container iframe{width:100%;height:100%;border:none;display:block}.app-talkative-footer{display:flex;align-items:center;justify-content:center;gap:4px;box-sizing:border-box;background-color:#fff9;height:26px;padding:0 16px;border-top:1px solid #eeeef7;color:#191919}.telebox-color-scheme-dark .app-talkative-footer{color:#a6a6a8;background:#2d2d33;border-top:none}.app-talkative-page{font-variant-numeric:tabular-nums}.app-talkative-btn{box-sizing:border-box;width:26px;height:26px;font-size:14px;font-family:monospace;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;-webkit-tap-highlight-color:rgba(0,0,0,0);cursor:pointer;user-select:none;-webkit-user-select:none}.app-talkative-btn:hover{background:rgba(237,237,240,.9)}.telebox-color-scheme-dark .app-talkative-btn:hover{background:#212126}.telebox-color-scheme-dark .app-talkative-container{color:#eee}.app-talkative-btn:disabled{opacity:0;cursor:default}
`,D=window.ResizeObserver||S;class O{constructor(t){this.context=t,this.sideEffect=new m,this.box=this.context.box,this.role=b(2),this.ratio=b(16/9),this.$content=l("div"),this.$iframe=l("iframe"),u(this.$content,"class","app-talkative-container"),g(this.$content,this.$iframe),this.$content.dataset.appKind="Talkative"}_on_update_role(t){this.$content.dataset.role=String(t),this.$content.classList.toggle("owner",t===0)}_on_update_ratio(t,s){const{width:n,height:o}=s?s.contentRect:this.$content.getBoundingClientRect();if(n/t>o){const h=o*t;this.$iframe.style.width=`${h}px`,this.$iframe.style.height=""}else if(n/t<o){const h=n/t;this.$iframe.style.width="",this.$iframe.style.height=`${h}px`}}_observe_content_resize(){const t=new D(s=>{this._on_update_ratio(this.ratio.value,s[0])});return t.observe(this.$content),t.disconnect.bind(t)}mount(){return this.box.mountStyles(C),this.box.mountContent(this.$content),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.ratio.subscribe(this._on_update_ratio.bind(this))),this.sideEffect.addDisposer(this._observe_content_resize()),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),x(this.$content)}postMessage(t){var s;(s=this.$iframe.contentWindow)==null||s.postMessage(t,"*")}}class P{constructor(t,s,n){this.context=t,this.onPrev=s,this.onNext=n,this.sideEffect=new m,this.box=this.context.box,this.role=b(2),this.text=b("..."),this.$footer=l("div"),this.$btnLeft=l("button"),this.$btnRight=l("button"),this.$span=l("span"),g(this.$footer,this.$btnLeft),g(this.$footer,this.$span),g(this.$footer,this.$btnRight),u(this.$footer,"class","app-talkative-footer"),u(this.$btnLeft,"class","app-talkative-btn app-talkative-btn-left"),u(this.$btnRight,"class","app-talkative-btn app-talkative-btn-right"),u(this.$span,"class","app-talkative-page"),this.$btnLeft.textContent="<",this.$btnRight.textContent=">",this.$btnLeft.addEventListener("click",this.onPrev),this.$btnRight.addEventListener("click",this.onNext)}_on_update_role(t){this.$btnLeft.disabled=t===2,this.$btnRight.disabled=t===2,this.$footer.classList.toggle("owner",t===0)}_on_update_text(t){this.$span.textContent=t}mount(){return this.box.mountFooter(this.$footer),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.text.subscribe(this._on_update_text.bind(this))),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),x(this.$footer)}}function A({context:e,storage:t,logger:s,...n}){const o=new m,h={onPagenum({totalPages:i}){e.isWritable&&i&&t.setState({pageNum:i})},onLoadComplete(i){n.onRatioChanged(i.coursewareRatio),e.isWritable&&i.totalPages&&t.setState({pageNum:i.totalPages});const{page:a,lastMsg:d}=t.state;d&&n.postMessage(d),n.postMessage(JSON.stringify({method:"onJumpPage",toPage:a}))},onFileMessage(i){if(e.isWritable){e.dispatchMagixEvent("broadcast",JSON.stringify(i));const a=JSON.stringify({...i,isRestore:!0});t.setState({lastMsg:a})}}};return o.addDisposer(e.addMagixEventListener("broadcast",({payload:i})=>{n.postMessage(i)})),o.addEventListener(window,"message",i=>{if(n.isSentBySelf(i.source))if(typeof i.data=="string")try{const a=JSON.parse(i.data);if(typeof a=="object"&&a!==null){const d=h[a.method];d?d(a):s.warn("unknown message",a)}}catch(a){s.warn("error when parsing message",a)}else typeof i.data=="object"&&i.data!==null&&s.log("unhandled permission command",i.data)}),o.flushAll.bind(o)}const T={kind:"Talkative",setup(e){const t=e.attributes,s=e.createStorage("talkative",{src:"https://example.org",uid:"",page:1,pageNum:1,lastMsg:"",...t}),n=(e.getAppOptions()||{}).debug,o=new N("Talkative",n),{uid:h,memberId:i,nickName:a}=R(e),d=new m;o.log("my uid",h);const y=()=>{const{page:r}=s.state;e.isWritable&&r>1&&s.setState({page:r-1})},w=()=>{const{page:r,pageNum:p}=s.state;e.isWritable&&r<p&&s.setState({page:r+1})},c=new O(e),f=new P(e,y,w),v=c.postMessage.bind(c);d.addDisposer(A({context:e,storage:s,logger:o,postMessage:v,onRatioChanged:c.ratio.set.bind(c.ratio),isSentBySelf:r=>r===c.$iframe.contentWindow})),d.addDisposer(s.on("stateChanged",()=>{const r=s.state.uid===h?0:2;c.role.set(r),f.role.set(r);const{page:p,pageNum:$}=s.state;v(JSON.stringify({method:"onJumpPage",toPage:p})),f.text.set(`${p}/${$}`)}));const k=()=>{d.addDisposer(c.mount()),d.addDisposer(f.mount());const r=s.state.uid===h?0:2,p=`userid=${i}&role=${r}&name=${a}`;c.$iframe.src=M(s.state.src,p),c.role.set(r),f.role.set(r);const{page:$,pageNum:E}=s.state;f.text.set(`${$}/${E}`)};if(s.state.uid)_.then(k);else{const r=d.addDisposer(s.on("stateChanged",()=>{s.state.uid&&(d.flush(r),k())}));e.isAddApp&&(o.log("no teacher's uid, setting myself..."),s.setState({uid:h}))}e.emitter.on("destroy",()=>{o.log("destroy"),d.flushAll()})}};export{T as default};
